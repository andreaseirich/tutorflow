{% extends 'core/base.html' %}

{% block title %}Neue Rechnung erstellen - TutorFlow{% endblock %}

{% block content %}
<h1>Neue Rechnung erstellen</h1>

<form method="post" id="invoice-form">
    {% csrf_token %}
    
    <div style="margin-bottom: 20px;">
        <label for="{{ form.period_start.id_for_label }}">Zeitraum:</label>
        {{ form.period_start }}
        {{ form.period_end }}
        {% if form.period_start.errors %}
        <div class="error">{{ form.period_start.errors }}</div>
        {% endif %}
        {% if form.period_end.errors %}
        <div class="error">{{ form.period_end.errors }}</div>
        {% endif %}
    </div>
    
    <div style="margin-bottom: 20px;">
        <label for="{{ form.contract.id_for_label }}">Vertrag (optional):</label>
        {{ form.contract }}
    </div>
    
    <button type="button" onclick="loadLessons()" class="btn">Lessons laden</button>
    
    {% if billable_lessons %}
    <h2>Verfügbare Unterrichtsstunden</h2>
    <p>Wählen Sie die Stunden aus, die abgerechnet werden sollen:</p>
    
    <table>
        <thead>
            <tr>
                <th>Auswählen</th>
                <th>Datum</th>
                <th>Zeit</th>
                <th>Schüler</th>
                <th>Dauer</th>
                <th>Betrag</th>
            </tr>
        </thead>
        <tbody>
            {% for lesson in billable_lessons %}
            <tr>
                <td>
                    <input type="checkbox" name="lesson_checkbox" value="{{ lesson.id }}" 
                           onchange="updateLessonIds()">
                </td>
                <td>{{ lesson.date|date:"d.m.Y" }}</td>
                <td>{{ lesson.start_time|time:"H:i" }}</td>
                <td>{{ lesson.contract.student.full_name }}</td>
                <td>{{ lesson.duration_minutes }} Min.</td>
                <td>
                    {% widthratio lesson.contract.hourly_rate 60 lesson.duration_minutes %}€
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {{ form.lesson_ids }}
    {% endif %}
    
    <div class="btn-group" style="margin-top: 20px;">
        <button type="submit" class="btn btn-success">Rechnung erstellen</button>
        <a href="{% url 'billing:invoice_list' %}" class="btn btn-secondary">Abbrechen</a>
    </div>
</form>

<script>
function updateLessonIds() {
    const checkboxes = document.querySelectorAll('input[name="lesson_checkbox"]:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
    document.getElementById('{{ form.lesson_ids.id_for_label }}').value = ids;
}

function loadLessons() {
    const form = document.getElementById('invoice-form');
    const periodStart = document.getElementById('{{ form.period_start.id_for_label }}').value;
    const periodEnd = document.getElementById('{{ form.period_end.id_for_label }}').value;
    const contract = document.getElementById('{{ form.contract.id_for_label }}').value;
    
    if (!periodStart || !periodEnd) {
        alert('Bitte geben Sie einen Zeitraum ein.');
        return;
    }
    
    const url = new URL(window.location.href);
    url.searchParams.set('period_start', periodStart);
    url.searchParams.set('period_end', periodEnd);
    if (contract) {
        url.searchParams.set('contract', contract);
    }
    
    window.location.href = url.toString();
}
</script>
{% endblock %}

