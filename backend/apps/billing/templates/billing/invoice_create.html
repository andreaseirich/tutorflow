{% extends 'core/base.html' %}
{% load i18n %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/billing.css' %}">
{% endblock %}

{% block title %}{% trans "Create New Invoice" %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Create New Invoice" %}</h1>

<div class="invoice-note-box">
    <strong>ðŸ’¡ {% trans "Note:" %}</strong>
    <p>
        {% trans "All taught lessons (status 'taught') in the specified period will be automatically included in the invoice. Lessons with status 'planned' or 'paid' will not be considered. A lesson can only appear in one invoice - lessons that are already included in another invoice will be automatically excluded." %}
    </p>
</div>

<form method="post" id="invoice-form">
    {% csrf_token %}
    
    <div class="form-section">
        <label for="{{ form.period_start.id_for_label }}">{% trans "Period:" %}</label>
        <div class="invoice-period-group">
            {{ form.period_start }}
            <span>{% trans "to" %}</span>
            {{ form.period_end }}
        </div>
        {% if form.period_start.errors %}
        <div class="error">{{ form.period_start.errors }}</div>
        {% endif %}
        {% if form.period_end.errors %}
        <div class="error">{{ form.period_end.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-section">
        <label for="{{ form.contract.id_for_label }}">{% trans "Contract (optional):" %}</label>
        {{ form.contract }}
        <small class="form-text text-muted">{% trans "If selected, only lessons from this contract will be billed." %}</small>
    </div>
    
    <button type="button" id="load-lessons-btn" class="btn" data-alert-msg="{% trans 'Please enter a period.' %}">{% trans "Show Preview" %}</button>
    
    {% if billable_lessons %}
    <h2>{% blocktrans count counter=billable_lessons|length %}Available Lesson ({{ counter }}){% plural %}Available Lessons ({{ counter }}){% endblocktrans %}</h2>
    <p>{% trans "These lessons will be automatically included in the invoice:" %}</p>
    
    <table class="invoice-table">
        <thead>
            <tr>
                <th>{% trans "Date" %}</th>
                <th>{% trans "Time" %}</th>
                <th>{% trans "Student" %}</th>
                <th>{% trans "Duration" %}</th>
                <th class="text-right">{% trans "Amount" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for lesson in billable_lessons %}
            <tr>
                <td>{{ lesson.date|date:"d.m.Y" }}</td>
                <td>{{ lesson.start_time|time:"H:i" }}</td>
                <td>{{ lesson.contract.student.full_name }}</td>
                <td>{% blocktrans with minutes=lesson.duration_minutes %}{{ minutes }} Min.{% endblocktrans %}</td>
                <td class="text-right">
                    {% with units=lesson.duration_minutes|floatformat:0 contract_unit=lesson.contract.unit_duration_minutes|floatformat:0 %}
                    {% widthratio lesson.duration_minutes contract_unit 1 as calculated_units %}
                    {% widthratio lesson.contract.hourly_rate 1 calculated_units as calculated_amount %}
                    {{ calculated_amount|floatformat:2 }}â‚¬
                    {% endwith %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% elif period_start and period_end %}
    <div class="invoice-warning-box">
        <p>{% trans "No billable lessons found in the specified period." %}</p>
        <p>
            {% trans "Make sure that:" %}
            <ul>
                <li>{% trans "There are lessons with status 'taught' in the period" %}</li>
                <li>{% trans "These lessons are not already included in another invoice" %}</li>
            </ul>
        </p>
    </div>
    {% endif %}
    
    <div class="btn-group" style="margin-top: 20px;">
        <button type="submit" class="btn btn-success" {% if not billable_lessons %}disabled{% endif %}>
            {% trans "Create Invoice" %}
        </button>
        <a href="{% url 'billing:invoice_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/billing.js' %}"></script>
{% endblock %}
