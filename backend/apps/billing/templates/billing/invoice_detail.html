{% extends 'core/base.html' %}
{% load i18n %}
{% load currency %}

{% block title %}{% blocktrans with id=invoice.id %}Invoice {{ id }}{% endblocktrans %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% blocktrans with id=invoice.id %}Invoice {{ id }}{% endblocktrans %}</h1>

<div class="btn-group">
    <a href="{% url 'billing:invoice_list' %}" class="btn btn-secondary">{% trans "Back to List" %}</a>
    {% if not invoice.document %}
    <a href="{% url 'billing:invoice_generate_document' invoice.pk %}" class="btn">üìÑ {% trans "Generate Document" %}</a>
    {% else %}
    <a href="{% url 'billing:invoice_document' invoice.pk %}" class="btn" target="_blank">üìÑ {% trans "View Document" %}</a>
    {% endif %}
    <form method="post" action="{% url 'billing:invoice_pdf_generate' invoice.pk %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn">üìë {% trans "Generate PDF" %}</button>
    </form>
    <a href="{% url 'billing:invoice_pdf_download' invoice.pk %}" class="btn" download>üì• {% trans "Download PDF" %}</a>
    {% if invoice.invoice_pdf %}<span class="btn btn-secondary">‚úì {% trans "PDF generated" %}{% if invoice.invoice_pdf_created_at %} ({{ invoice.invoice_pdf_created_at|date:"SHORT_DATETIME_FORMAT" }}){% endif %}</span>{% endif %}
    {% if invoice.status == "draft" %}
    <form method="post" action="{% url 'billing:invoice_mark_sent' invoice.pk %}" style="display:inline;">{% csrf_token %}<button type="submit" class="btn">‚úâÔ∏è {% trans "Mark as sent" %}</button></form>
    {% endif %}
    {% if invoice.status == "draft" or invoice.status == "sent" %}
    <form method="post" action="{% url 'billing:invoice_mark_paid' invoice.pk %}" style="display:inline;">{% csrf_token %}<button type="submit" class="btn">‚úì {% trans "Mark as paid" %}</button></form>
    {% endif %}
    {% if invoice.status == "paid" %}
    <form method="post" action="{% url 'billing:invoice_undo_paid' invoice.pk %}" style="display:inline;">{% csrf_token %}<button type="submit" class="btn btn-secondary">‚Ü© {% trans "Undo payment" %}</button></form>
    {% endif %}
    <a href="{% url 'billing:invoice_delete' invoice.pk %}" class="btn btn-danger">üóëÔ∏è {% trans "Delete" %}</a>
</div>

<h2>{% trans "Details" %}</h2>
<table>
    <tr><th>{% trans "Payer" %}</th><td>{{ invoice.payer_name }}</td></tr>
    {% if invoice.payer_address %}<tr><th>{% trans "Address" %}</th><td>{{ invoice.payer_address|linebreaks }}</td></tr>{% endif %}
    {% if invoice.contract %}<tr><th>{% trans "Contract" %}</th><td><a href="{% url 'contracts:detail' invoice.contract.pk %}">{{ invoice.contract }}</a></td></tr>{% endif %}
    <tr><th>{% trans "Period" %}</th><td>{{ invoice.period_start|date:"SHORT_DATE_FORMAT" }} - {{ invoice.period_end|date:"SHORT_DATE_FORMAT" }}</td></tr>
    <tr><th>{% trans "Status" %}</th><td>{{ invoice.get_status_display }}{% if invoice.paid_at %} ({% trans "paid at" %} {{ invoice.paid_at|date:"SHORT_DATETIME_FORMAT" }}){% endif %}</td></tr>
    <tr><th>{% trans "Total Amount" %}</th><td><strong>{{ invoice.total_amount|euro }}</strong></td></tr>
    <tr><th>{% trans "Created" %}</th><td>{{ invoice.created_at|date:"SHORT_DATETIME_FORMAT" }}</td></tr>
</table>

<h2>{% trans "Invoice Items" %}</h2>
{% if invoice.items.all %}
<table>
    <thead>
        <tr>
            <th>{% trans "Date" %}</th>
            <th>{% trans "Description" %}</th>
            <th>{% trans "Duration" %}</th>
            <th>{% trans "Amount" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for item in invoice.items.all %}
        <tr>
            <td>{{ item.date|date:"SHORT_DATE_FORMAT" }}</td>
            <td>{{ item.description }}</td>
            <td>{% blocktrans with minutes=item.duration_minutes %}{{ minutes }} Min.{% endblocktrans %}</td>
            <td>{{ item.amount|euro }}</td>
        </tr>
        {% endfor %}
        <tr style="font-weight: bold; border-top: 2px solid #333;">
            <td colspan="3">{% trans "Total:" %}</td>
            <td>{{ invoice.total_amount|euro }}</td>
        </tr>
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p>{% trans "No invoice items available." %}</p>
</div>
{% endif %}
{% endblock %}
