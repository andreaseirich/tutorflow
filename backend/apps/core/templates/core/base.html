{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TutorFlow">
    <meta name="description" content="TutorFlow - Tutoring Management System">
    <link rel="manifest" href="{% url 'core:manifest' %}">
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192x192.png' %}">
    <title>{% block title %}TutorFlow{% endblock %}</title>
    <style>
        * { box-sizing: border-box; }
        
        /* CSS Variables for Light/Dark Mode */
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-nav: #2c3e50;
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --text-nav: #ffffff;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --hover-bg: #34495e;
            --active-bg: #3498db;
            --table-header-bg: #f8f9fa;
            --table-hover-bg: #f8f9fa;
            --input-border: #ddd;
            --input-focus: rgba(0,123,255,0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-nav: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-nav: #ffffff;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
            --hover-bg: #3a3a3a;
            --active-bg: #3498db;
            --table-header-bg: #353535;
            --table-hover-bg: #3a3a3a;
            --input-border: #404040;
            --input-focus: rgba(52,152,219,0.2);
        }
        
        /* Respect system preference */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-nav: #1e1e1e;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-nav: #ffffff;
                --border-color: #404040;
                --shadow: rgba(0,0,0,0.3);
                --hover-bg: #3a3a3a;
                --active-bg: #3498db;
                --table-header-bg: #353535;
                --table-hover-bg: #3a3a3a;
                --input-border: #404040;
                --input-focus: rgba(52,152,219,0.2);
            }
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: var(--bg-secondary); 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px var(--shadow); 
            min-height: calc(100vh - 80px); 
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Navigation */
        nav { background: var(--bg-nav); padding: 15px 0; margin-bottom: 30px; border-radius: 4px; box-shadow: 0 2px 4px var(--shadow); position: sticky; top: 0; z-index: 1000; transition: background-color 0.3s ease; }
        nav .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; }
        nav .nav-links { display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; flex: 1; }
        nav a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 3px; transition: background 0.2s; white-space: nowrap; -webkit-tap-highlight-color: transparent; }
        nav a:hover { background: var(--hover-bg); }
        nav a.active { background: var(--active-bg); }
        
        /* Dark Mode Toggle Button */
        .theme-toggle { 
            background: transparent; 
            border: none; 
            color: var(--text-nav); 
            padding: 8px 10px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 18px; 
            transition: background 0.2s; 
            min-width: 36px; 
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.1); }
        nav .nav-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        nav .nav-right form { margin: 0; }
        nav .nav-right button { background: transparent; color: white; border: none; padding: 8px 10px; border-radius: 3px; cursor: pointer; font-size: 18px; transition: background 0.2s; min-width: 36px; -webkit-tap-highlight-color: transparent; }
        nav .nav-right button:hover { background: rgba(255,255,255,0.1); }
        nav .nav-right select { font-size: 14px; }
        
        /* Hamburger Menu */
        .menu-toggle { display: none; background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 8px; -webkit-tap-highlight-color: transparent; }
        .menu-toggle:focus { outline: none; }
        
        .messages { margin-bottom: 20px; }
        .message { padding: 12px 15px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid; transition: background-color 0.3s ease, color 0.3s ease; }
        .message.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .message.warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        .message.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        [data-theme="dark"] .message.success { background: rgba(40, 167, 69, 0.2); color: #6cff8f; border-color: #28a745; }
        [data-theme="dark"] .message.warning { background: rgba(255, 193, 7, 0.2); color: #ffd54f; border-color: #ffc107; }
        [data-theme="dark"] .message.error { background: rgba(220, 53, 69, 0.2); color: #ff6b7a; border-color: #dc3545; }
        .conflict { color: #dc3545; font-weight: bold; background: #fff3cd; padding: 2px 6px; border-radius: 3px; }
        [data-theme="dark"] .conflict { color: #ff6b7a; background: rgba(255, 193, 7, 0.2); }
        .conflict-icon { color: #dc3545; font-size: 1.2em; }
        [data-theme="dark"] .conflict-icon { color: #ff6b7a; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px var(--shadow); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        th { background: var(--table-header-bg); font-weight: 600; color: var(--text-primary); }
        tr:hover { background: var(--table-hover-bg); }
        
        /* Buttons - Touch optimized */
        .btn { display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; font-size: 16px; transition: background 0.2s, transform 0.1s; -webkit-tap-highlight-color: transparent; min-height: 44px; min-width: 44px; touch-action: manipulation; }
        .btn:hover { background: #0056b3; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-group { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .btn-group .btn { margin-right: 0; }
        .premium-badge { background: #ffc107; color: #856404; padding: 4px 8px; border-radius: 3px; font-size: 0.85em; font-weight: bold; margin-left: 8px; }
        
        h1 { color: var(--text-primary); margin-top: 0; }
        h2 { color: var(--text-secondary); margin-top: 30px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        h3 { color: var(--text-secondary); }
        p { color: var(--text-primary); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        .empty-state p { font-size: 1.1em; color: var(--text-secondary); }
        a { color: #007bff; }
        a:hover { color: #0056b3; }
        
        /* Form inputs - Touch optimized */
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], textarea, select { 
            font-size: 16px; 
            padding: 12px; 
            border: 1px solid var(--input-border); 
            border-radius: 4px; 
            width: 100%; 
            background: var(--bg-secondary);
            color: var(--text-primary);
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none; 
            touch-action: manipulation;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="number"]:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #007bff; 
            box-shadow: 0 0 0 3px var(--input-focus); 
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; margin: 10px; border-radius: 0; }
            nav { margin-bottom: 15px; border-radius: 0; }
            nav .nav-container { padding: 0 15px; }
            .menu-toggle { display: block; }
            nav .nav-links { 
                position: fixed; 
                top: 60px; 
                left: -100%; 
                width: 80%; 
                max-width: 300px; 
                height: calc(100vh - 60px); 
                background: var(--bg-nav); 
                flex-direction: column; 
                align-items: stretch; 
                padding: 20px 0; 
                transition: left 0.3s ease, background-color 0.3s ease; 
                box-shadow: 2px 0 10px var(--shadow);
                z-index: 999;
            }
            nav .nav-links.active { left: 0; }
            nav .nav-links a { 
                display: block; 
                padding: 15px 20px; 
                border-bottom: 1px solid var(--hover-bg); 
                font-size: 16px;
            }
            nav .nav-right { gap: 5px; }
            table { font-size: 14px; }
            th, td { padding: 8px 4px; }
            .btn { padding: 12px 16px; font-size: 15px; width: 100%; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; margin-top: 20px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; margin: 5px; }
            table { font-size: 12px; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            th, td { padding: 6px 3px; white-space: nowrap; }
        }
        
        /* Safe area for notched devices */
        @supports (padding: max(0px)) {
            nav { padding-top: max(15px, env(safe-area-inset-top)); }
            .container { padding-bottom: max(30px, env(safe-area-inset-bottom)); }
        }
        
        /* Calendar Dark Mode Styles */
        [data-theme="dark"] .calendar-table th {
            background: var(--table-header-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        [data-theme="dark"] .calendar-table td {
            border-color: var(--border-color);
            background: var(--bg-secondary);
        }
        [data-theme="dark"] .calendar-table td:not(.current-month) {
            background: rgba(255,255,255,0.03);
            color: var(--text-secondary);
        }
        [data-theme="dark"] .calendar-note {
            color: var(--text-secondary);
        }
        [data-theme="dark"] .calendar-legend {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] .lesson-past {
            background: rgba(255,255,255,0.05) !important;
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] .lesson-future {
            background: rgba(33, 150, 243, 0.2) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .lesson-link {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .blocked-time {
            background: rgba(255, 193, 7, 0.2) !important;
            color: #ffd54f !important;
            border-left-color: #ffc107 !important;
        }
        [data-theme="dark"] .blocked-time a {
            color: #ffd54f !important;
        }
        [data-theme="dark"] .week-calendar th {
            background: var(--table-header-bg);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .week-calendar td {
            border-color: var(--border-color);
            background: var(--bg-secondary);
        }
        [data-theme="dark"] .week-calendar .time-slot {
            background: var(--bg-secondary);
        }
        [data-theme="dark"] .week-calendar .time-slot:hover {
            background: rgba(255,255,255,0.05);
        }
        [data-theme="dark"] .week-calendar .time-label {
            background: rgba(255,255,255,0.03);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .week-calendar .today-header {
            background: rgba(33, 150, 243, 0.15) !important;
        }
        [data-theme="dark"] .create-dialog {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        [data-theme="dark"] .create-dialog-overlay {
            background: rgba(0,0,0,0.7);
        }
        [data-theme="dark"] .preview-tooltip {
            background: var(--bg-nav);
            color: var(--text-nav);
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <button class="menu-toggle" id="menuToggle" aria-label="{% trans 'Toggle menu' %}">‚ò∞</button>
            <div class="nav-links" id="navLinks">
                <a href="{% url 'core:dashboard' %}">üìä {% trans "Dashboard" %}</a>
                <a href="{% url 'students:list' %}">üë• {% trans "Students" %}</a>
                <a href="{% url 'contracts:list' %}">üìÑ {% trans "Contracts" %}</a>
                <a href="{% url 'lessons:week' %}">üìÖ {% trans "Calendar" %}</a>
                <a href="{% url 'billing:invoice_list' %}">üßæ {% trans "Invoices" %}</a>
                <a href="{% url 'core:income' %}">üí∞ {% trans "Income" %}</a>
                <a href="{% url 'core:reports' %}">üìà {% trans "Reports" %}</a>
                <a href="{% url 'core:settings' %}">‚öôÔ∏è {% trans "Settings" %}</a>
            </div>
            <div class="nav-right">
                <button class="theme-toggle" id="themeToggle" title="{% trans 'Toggle dark mode' %}" aria-label="{% trans 'Toggle dark mode' %}">
                    <span id="themeIcon">üåô</span>
                </button>
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'core:logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" title="{% trans 'Logout' %} ({{ user.username }})" class="btn-logout">üö™</button>
                </form>
                {% else %}
                {% if not user.is_authenticated %}
                <a href="{% url 'core:landing' %}" title="{% trans 'Home' %}">üè†</a>
                <a href="{% url 'core:login' %}" title="{% trans 'Login' %}">üîê</a>
                {% else %}
                <a href="{% url 'core:login' %}" title="{% trans 'Login' %}">üîê</a>
                {% endif %}
                {% endif %}
                <form action="{% url 'set_language' %}" method="post" style="display: inline-block; margin: 0;">
                    {% csrf_token %}
                    <input name="next" type="hidden" value="{{ request.get_full_path }}">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% get_available_languages as LANGUAGES %}
                    <select name="language" onchange="this.form.submit()" title="{% trans 'Change language' %}" style="background: #34495e; color: white; border: none; padding: 8px 10px; border-radius: 3px; cursor: pointer; font-size: 14px; min-width: 50px;">
                        {% for lang_code, lang_name in LANGUAGES %}
                        <option value="{{ lang_code }}" {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>{% if lang_code == 'de' %}DE{% elif lang_code == 'en' %}EN{% else %}{{ lang_code|upper }}{% endif %}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </nav>
    
    <div class="container">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </div>

    {% include 'partials/footer.html' %}

    <script>
    window.I18N = Object.assign(window.I18N || {}, {
        networkError: "{% trans 'Network error: Please check your internet connection.' %}",
        error: "{% trans 'Error' %}",
    });
    </script>
    <script>
    // Dark Mode Toggle
    (function() {
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;
        
        // Get saved theme or detect system preference
        function getInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        }
        
        // Apply theme
        function setTheme(theme) {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (themeIcon) {
                themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        // Initialize theme
        const initialTheme = getInitialTheme();
        setTheme(initialTheme);
        
        // Toggle theme on button click
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            });
        }
        
        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                // Only auto-switch if user hasn't manually set a preference
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }
    })();
    
    // Mobile Menu Toggle
    document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.getElementById('menuToggle');
        const navLinks = document.getElementById('navLinks');
        
        if (menuToggle && navLinks) {
            menuToggle.addEventListener('click', function() {
                navLinks.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!navLinks.contains(event.target) && !menuToggle.contains(event.target)) {
                    navLinks.classList.remove('active');
                }
            });
            
            // Close menu when clicking a link
            navLinks.querySelectorAll('a').forEach(function(link) {
                link.addEventListener('click', function() {
                    navLinks.classList.remove('active');
                });
            });
        }
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('{% url "core:service_worker" %}')
                    .then(function(registration) {
                        // Service worker registered successfully
                    })
                    .catch(function(error) {
                        // Service worker registration failed
                    });
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            // Optional: Show install button
        });
        
        // General function to populate date fields from GET parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Helper function to format date values
        function formatDateForInput(value) {
            if (!value) return null;
            
            // Wenn bereits im richtigen Format (YYYY-MM-DD), verwende es direkt
            if (value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return value;
            }
            
            // Versuche, verschiedene Datumsformate zu parsen
            try {
                // Django rendert manchmal Datumswerte im Format "DD.MM.YYYY" oder "DD/MM/YYYY"
                if (value.match(/^\d{1,2}[.\/]\d{1,2}[.\/]\d{4}$/)) {
                    const parts = value.split(/[.\/]/);
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
                
                // Versuche, als Date zu parsen
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                // Ignoriere Fehler
            }
            
            return null;
        }
        
        // Finde alle Datumsfelder (type="date")
        const dateFields = document.querySelectorAll('input[type="date"]');
        dateFields.forEach(function(field) {
            // Wenn das Feld einen Wert hat, aber nicht im richtigen Format, korrigiere es
            if (field.value && !field.value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const formatted = formatDateForInput(field.value);
                if (formatted) {
                    field.value = formatted;
                }
            }
            
            // Wenn das Feld leer ist, versuche, den Wert aus GET-Parametern zu setzen
            if (!field.value) {
                const fieldName = field.name || field.id;
                // Versuche verschiedene Parameternamen
                const possibleParams = [
                    fieldName,
                    fieldName.replace('_', '_'),
                    'date',
                    'period_start',
                    'period_end',
                    'start_date',
                    'end_date',
                ];
                
                for (const param of possibleParams) {
                    const value = urlParams.get(param);
                    if (value) {
                        const formatted = formatDateForInput(value);
                        if (formatted) {
                            field.value = formatted;
                            break;
                        }
                    }
                }
            }
        });
        
        // Hilfsfunktion zum Formatieren von Zeitwerten
        function formatTimeForInput(value) {
            if (!value) return null;
            
            // Wenn bereits im richtigen Format (HH:MM), verwende es direkt
            if (value.match(/^\d{2}:\d{2}$/)) {
                return value;
            }
            
            // Versuche, verschiedene Zeitformate zu parsen
            try {
                // Django rendert manchmal Zeitwerte im Format "HH:MM:SS"
                if (value.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) {
                    const parts = value.split(':');
                    const hours = parts[0].padStart(2, '0');
                    const minutes = parts[1].padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
            } catch (e) {
                // Ignoriere Fehler
            }
            
            return null;
        }
        
        // Finde alle Zeitfelder (type="time")
        const timeFields = document.querySelectorAll('input[type="time"]');
        timeFields.forEach(function(field) {
            // Wenn das Feld einen Wert hat, aber nicht im richtigen Format, korrigiere es
            if (field.value && !field.value.match(/^\d{2}:\d{2}$/)) {
                const formatted = formatTimeForInput(field.value);
                if (formatted) {
                    field.value = formatted;
                }
            }
        });
        
        // Central API helper function with proper error handling
        /**
         * Makes an API request with comprehensive error handling
         * @param {string} url - The API endpoint URL
         * @param {Object} options - Fetch options (method, headers, body, etc.)
         * @returns {Promise<Object>} - Parsed JSON response
         */
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        ...options.headers
                    }
                });
                
                // Check if response is ok (status 200-299)
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If response is not JSON, use status text
                    }
                    throw new Error(errorMessage);
                }
                
                // Parse JSON response
                const data = await response.json();
                return data;
            } catch (error) {
                // Handle network errors, JSON parse errors, etc.
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    throw new Error((window.I18N && window.I18N.networkError) || 'Network error');
                }
                throw error;
            }
        }
        
        // Finde alle datetime-local Felder
        const datetimeFields = document.querySelectorAll('input[type="datetime-local"]');
        datetimeFields.forEach(function(field) {
            if (!field.value) {
                const fieldName = field.name || field.id;
                const possibleParams = [
                    fieldName,
                    'start_datetime',
                    'end_datetime',
                    'start',
                    'end',
                ];
                
                for (const param of possibleParams) {
                    const value = urlParams.get(param);
                    if (value) {
                        try {
                            // Konvertiere ISO-Format zu datetime-local Format
                            const date = new Date(value.replace('Z', '+00:00'));
                            if (!isNaN(date.getTime())) {
                                // Konvertiere zu datetime-local Format (YYYY-MM-DDTHH:mm)
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                field.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                                break;
                            }
                        } catch (e) {
                            // Ignoriere Fehler
                        }
                    }
                }
            }
        });
    });
    </script>
</body>
</html>

