{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% trans "Settings" %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Settings" %}</h1>

<div class="btn-group">
    <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">{% trans "Back to Dashboard" %}</a>
</div>

<h2>{% trans "Default Working Hours" %}</h2>
<p>{% trans "Set your default working hours. These will be used for student booking pages when a contract doesn't have specific working hours configured." %}</p>

<form method="post">
    {% csrf_token %}
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Monday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.monday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.monday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.monday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Tuesday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.tuesday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.tuesday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.tuesday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Wednesday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.wednesday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.wednesday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.wednesday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Thursday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.thursday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.thursday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.thursday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Friday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.friday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.friday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.friday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Saturday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.saturday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.saturday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.saturday_end }}
                </div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #34495e;">{% trans "Sunday" %}</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    {{ form.sunday_enabled }}
                    <span>{% trans "Enabled" %}</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "Start time" %}</label>
                    {{ form.sunday_start }}
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #495057;">{% trans "End time" %}</label>
                    {{ form.sunday_end }}
                </div>
            </div>
        </div>
    </div>
    
    {% if form.non_field_errors %}
    <div class="message error" style="margin-top: 20px;">
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    
    <div class="btn-group" style="margin-top: 30px;">
        <button type="submit" class="btn btn-success">{% trans "Save Working Hours" %}</button>
        <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
</form>

{% if show_stripe_success_banner %}
<div class="message" style="margin-bottom: 20px; padding: 12px 16px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
    {% trans "Payment received. Subscription activation may take a moment. Refresh if Premium is not visible yet." %}
</div>
{% endif %}
{% if show_email_recommendation %}
<div class="message" style="margin-bottom: 20px; padding: 12px 16px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404;">
    {% trans "For invoices and Stripe we recommend adding an email address." %}
</div>
{% endif %}
<h2 style="margin-top: 40px;">{% trans "Email address" %}</h2>
<p>{% trans "Optional. Used for invoices and Stripe billing notifications." %}</p>
<form method="post" style="margin-top: 15px;">
    {% csrf_token %}
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        {{ email_form.email }}
        <button type="submit" name="save_email" class="btn btn-secondary">{% trans "Save" %}</button>
    </div>
    {% if email_form.email.errors %}<p style="color: #dc3545; margin-top: 5px;">{{ email_form.email.errors.0 }}</p>{% endif %}
</form>
<h2 style="margin-top: 40px;">{% trans "Subscription" %}</h2>
<p>{% trans "Manage your Premium subscription. Premium unlocks unlimited public booking, reschedule, reports, Billing Pro, and AI lesson plans." %}</p>
<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
    <p style="margin: 0 0 15px 0;"><strong>{% trans "Current plan" %}:</strong>
        {% if is_premium %}
            <span class="premium-badge">{% trans "Premium" %}</span>
        {% else %}
            {% trans "Basic" %}
        {% endif %}
    </p>
    {% if stripe_premium_checkout_enabled %}
        {% if is_premium and profile.stripe_customer_id %}
            <button type="button" class="btn" id="stripe-portal-btn">{% trans "Manage subscription" %}</button>
        {% elif is_premium %}
            <span style="color: #6c757d;">{% trans "Premium (manual or demo)" %}</span>
        {% else %}
            <form method="post" action="{% url 'stripe_checkout' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">{% trans "Activate Premium" %}</button>
            </form>
        {% endif %}
    {% elif stripe_enabled %}
        {% if is_premium and profile.stripe_customer_id %}
            <form method="post" action="{% url 'core:subscription_portal' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn">{% trans "Manage subscription" %}</button>
            </form>
        {% elif is_premium %}
            <span style="color: #6c757d;">{% trans "Premium (manual or demo)" %}</span>
        {% else %}
            <form method="post" action="{% url 'core:subscription_checkout' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">{% trans "Upgrade to Premium" %}</button>
            </form>
        {% endif %}
    {% else %}
        <p style="margin: 0; color: #6c757d; font-size: 0.95em;">{% trans "Payment is not configured. Premium upgrades are currently unavailable." %}</p>
    {% endif %}
</div>
{% if stripe_premium_checkout_enabled and is_premium and profile.stripe_customer_id %}
<script>
(function() {
    var btn = document.getElementById('stripe-portal-btn');
    if (!btn) return;
    btn.addEventListener('click', function() {
        btn.disabled = true;
        var csrf = document.querySelector('[name=csrfmiddlewaretoken]');
        var token = csrf ? csrf.value : '';
        fetch('{% url "stripe_portal" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': token, 'Content-Type': 'application/json' },
            body: '{}'
        }).then(function(r) {
            if (!r.ok) return r.json().then(function(d) { alert(d.error || (window.I18N && window.I18N.error)); });
            return r.json();
        }).then(function(d) {
            if (d && d.portal_url) window.location.href = d.portal_url;
        }).catch(function() { alert('{% trans "Could not open billing portal." %}'); })
        .finally(function() { btn.disabled = false; });
    });
})();
</script>
{% endif %}

<h2 style="margin-top: 40px;">{% trans "Your Booking Links" %}</h2>
<p>{% trans "Each user has their own booking links. Share only your links with your students." %}</p>

<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold;">{% trans "Public Booking Link (your personal link)" %}</label>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="public-booking-url"
               value="{{ public_booking_url }}" 
               readonly 
               style="flex: 1; min-width: 200px; padding: 10px; font-family: monospace; font-size: 0.9em; border: 1px solid #ddd; border-radius: 4px;"
               onclick="this.select();">
        <button type="button" class="btn btn-secondary" onclick="copyToClipboard('public-booking-url')">{% trans "Copy" %}</button>
    </div>
    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
        {% trans "Share this link with new students. They can enter their name and book lessons." %}
    </p>
</div>

{% if contract_booking_urls %}
<h3 style="margin-top: 30px; color: #34495e;">{% trans "Contract Booking Links (per student)" %}</h3>
<p style="font-size: 0.95em; color: #6c757d;">{% trans "Each contract has its own link. Share the link with the respective student for direct booking." %}</p>
<div style="margin-top: 15px;">
    {% for item in contract_booking_urls %}
    <div style="margin-bottom: 15px; padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px;">
        <strong>{{ item.contract.student.full_name }}</strong>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 8px;">
            <input type="text" id="contract-url-{{ item.contract.id }}" readonly
                   value="{{ item.url }}"
                   style="flex: 1; min-width: 200px; padding: 8px; font-family: monospace; font-size: 0.85em; border: 1px solid #ddd; border-radius: 4px;"
                   onclick="this.select();">
            <button type="button" class="btn btn-secondary" style="padding: 8px 15px;" 
                    onclick="copyContractUrl({{ item.contract.id }})">{% trans "Copy" %}</button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
function copyToClipboard(inputId) {
    const input = document.getElementById(inputId);
    input.select();
    document.execCommand('copy');
    const btn = input.nextElementSibling;
    if (btn && btn.tagName === 'BUTTON') {
        const orig = btn.textContent;
        btn.textContent = '{% trans "Copied!" %}';
        setTimeout(function() { btn.textContent = orig; }, 1500);
    }
}
function copyContractUrl(contractId) {
    const input = document.getElementById('contract-url-' + contractId);
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(input.value).then(function() {
            const btn = input.nextElementSibling;
            if (btn) { btn.textContent = '{% trans "Copied!" %}'; setTimeout(function() { btn.textContent = '{% trans "Copy" %}'; }, 1500); }
        });
    } else {
        input.select();
        document.execCommand('copy');
        const btn = input.nextElementSibling;
        if (btn) { btn.textContent = '{% trans "Copied!" %}'; setTimeout(function() { btn.textContent = '{% trans "Copy" %}'; }, 1500); }
    }
}
</script>
{% endblock %}
