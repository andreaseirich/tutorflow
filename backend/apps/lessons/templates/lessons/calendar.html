{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% blocktrans with month=month_label year=year %}Calendar {{ month }} {{ year }}{% endblocktrans %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% blocktrans with month=month_label year=year %}Calendar {{ month }} {{ year }}{% endblocktrans %}</h1>

<div class="btn-group" style="margin-bottom: 20px;">
    <a href="{% url 'lessons:calendar' %}?year={{ prev_year }}&month={{ prev_month }}" class="btn">â† {% trans "Previous Month" %}</a>
    <a href="{% url 'lessons:week' %}?year={{ year }}&month={{ month }}&day=1" class="btn">{% trans "Week View" %}</a>
    <a href="{% url 'lessons:calendar' %}?year={{ next_year }}&month={{ next_month }}" class="btn">{% trans "Next Month" %} â†’</a>
</div>


<p style="margin-top: 10px; color: #495057; font-size: 0.9em;">
    <strong>{% trans "Note:" %}</strong> {% trans "Click on a day to create a new lesson. Click on an existing lesson to edit it." %}
</p>

<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr>
            {% for weekday in weekday_names %}
            <th style="border: 1px solid #ddd; padding: 10px; background: #f5f5f5; text-align: center;">{{ weekday }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for week in weeks %}
        <tr>
            {% for day in week %}
            <td style="border: 1px solid #ddd; padding: 8px; vertical-align: top; {% if not day.is_current_month %}background: #f9f9f9; color: #999;{% endif %} min-height: 100px; width: 14.28%; position: relative;">
                <div style="font-weight: bold; margin-bottom: 5px;">
                    {% if day.is_current_month %}
                    <a href="{% url 'lessons:create' %}?date={{ day.date|date:'Y-m-d' }}&year={{ year }}&month={{ month }}" 
                       style="color: #007bff; text-decoration: none; border-bottom: 1px dashed #007bff;"
                       title="{% trans 'Create new lesson' %}">
                        {{ day.date.day }}
                    </a>
                    <a href="{% url 'blocked_times:create' %}?date={{ day.date|date:'Y-m-d' }}&year={{ year }}&month={{ month }}" 
                       style="color: #856404; text-decoration: none; margin-left: 5px; font-size: 0.8em;"
                       title="{% trans 'Add blocked time' %}">
                        ğŸš«
                    </a>
                    {% else %}
                    {{ day.date.day }}
                    {% endif %}
                </div>
                
                {% if day.lessons %}
                <div style="margin-bottom: 5px;">
                    {% for lesson in day.lessons %}
                    <div style="display: block; background: {% if lesson.date < today %}#f5f5f5{% else %}#e3f2fd{% endif %}; padding: 3px; margin-bottom: 2px; font-size: 0.85em; border-left: 3px solid {% if lesson.id in conflicts_by_lesson %}#dc3545{% else %}#2196f3{% endif %}; {% if lesson.date < today %}opacity: 0.7;{% endif %}">
                        <a href="{% url 'lessons:detail' lesson.pk %}" 
                           style="text-decoration: none; color: #333; display: block;"
                           title="{% if lesson.travel_time_before_minutes > 0 %}ğŸš— {{ lesson.travel_time_before_minutes }} {% trans 'Min.' %} â†’ {% endif %}{{ lesson.contract.student.full_name }} - {{ lesson.start_time|time:'H:i' }} ({{ lesson.duration_minutes }} {% trans 'Min.' %}){% if lesson.travel_time_after_minutes > 0 %} â†’ ğŸš— {{ lesson.travel_time_after_minutes }} {% trans 'Min.' %}{% endif %}">
                            {% if lesson.travel_time_before_minutes > 0 %}<span style="font-size: 0.8em;">ğŸš—</span>{% endif %}
                            <strong>{{ lesson.start_time|time:"H:i" }}</strong> 
                            {{ lesson.contract.student.first_name }}
                            <small style="opacity: 0.8;">({{ lesson.duration_minutes }}{% if lesson.travel_time_before_minutes > 0 or lesson.travel_time_after_minutes > 0 %}+{{ lesson.travel_time_before_minutes|add:lesson.travel_time_after_minutes }}{% endif %} {% trans "Min." %})</small>
                            {% if lesson.id in conflicts_by_lesson %}
                            <a href="{% url 'lessons:conflicts' lesson.pk %}" 
                               style="color: #dc3545; text-decoration: none; margin-left: 5px;"
                               title="{% trans 'Show conflict details' %}">âš  {% trans "Details" %}</a>
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if day.blocked_times %}
                <div>
                    {% for blocked_time in day.blocked_times %}
                    <div style="background: #fff3cd; padding: 3px; margin-bottom: 2px; font-size: 0.85em; color: #856404; border-left: 3px solid #ffc107;">
                        <a href="{% url 'blocked_times:detail' blocked_time.pk %}?year={{ year }}&month={{ month }}" 
                           style="text-decoration: none; color: #856404; display: block;"
                           title="{% trans 'View/edit blocked time' %}">
                            ğŸš« <strong>{{ blocked_time.start_datetime|time:"H:i" }}</strong> {{ blocked_time.title }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
    <strong>{% trans "Legend:" %}</strong>
    <span style="display: inline-block; margin-left: 10px; padding: 3px 8px; background: #e3f2fd; border-left: 3px solid #2196f3;">{% trans "Lesson (clickable to edit)" %}</span>
    <span style="display: inline-block; margin-left: 10px; padding: 3px 8px; background: #e3f2fd; border-left: 3px solid #dc3545;">âš  {% trans "Conflict" %}</span>
    <span style="display: inline-block; margin-left: 10px; padding: 3px 8px; background: #fff3cd; border-left: 3px solid #ffc107;">ğŸš« {% trans "Blocked Time (clickable to edit)" %}</span>
    <span style="display: inline-block; margin-left: 10px; color: #007bff; border-bottom: 1px dashed #007bff;">{% trans "Days (clickable to create)" %}</span>
</div>
{% endblock %}
