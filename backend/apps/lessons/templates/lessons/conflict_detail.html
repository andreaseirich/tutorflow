{% extends 'core/base.html' %}
{% load i18n %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/lessons.css' %}">
{% endblock %}

{% block title %}{% blocktrans with date=lesson.date %}Conflicts - {{ date }}{% endblocktrans %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Conflicts for Lesson" %}</h1>

<div class="conflict-detail-container">
    <a href="{% url 'lessons:detail' lesson.pk %}" class="btn">‚Üê {% trans "Back to Lesson" %}</a>
    <a href="{% url 'lessons:week' %}?year={{ lesson.date.year }}&month={{ lesson.date.month }}&day={{ lesson.date.day }}" class="btn">‚Üê {% trans "Back to Calendar" %}</a>
</div>

<div class="conflict-info-box">
    <h2>{% trans "Lesson" %}</h2>
    <p><strong>{% trans "Date:" %}</strong> {{ lesson.date|date:"d.m.Y" }}</p>
    <p><strong>{% trans "Time:" %}</strong> {% blocktrans with time=lesson.start_time|time:"H:i" minutes=lesson.duration_minutes %}{{ time }} ({{ minutes }} Min.){% endblocktrans %}</p>
    <p><strong>{% trans "Student:" %}</strong> {{ lesson.contract.student.full_name }}</p>
</div>

{% if conflict_lessons %}
<div class="conflict-warning-box">
    <h2>{% blocktrans count counter=conflict_lessons|length %}Conflicting Lesson{% plural %}Conflicting Lessons ({{ counter }}){% endblocktrans %}</h2>
    
    <table class="conflict-table">
        <thead>
            <tr>
                <th>{% trans "Date" %}</th>
                <th>{% trans "Time" %}</th>
                <th>{% trans "Student" %}</th>
                <th>{% trans "Action" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for conflict_lesson in conflict_lessons %}
            <tr>
                <td>{{ conflict_lesson.date|date:"d.m.Y" }}</td>
                <td>{{ conflict_lesson.start_time|time:"H:i" }}</td>
                <td>{{ conflict_lesson.contract.student.full_name }}</td>
                <td>
                    <a href="{% url 'lessons:detail' conflict_lesson.pk %}" class="btn btn-small">{% trans "View" %}</a>
                    <a href="{% url 'lessons:update' conflict_lesson.pk %}" class="btn btn-primary btn-small">{% trans "Edit" %}</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if conflict_blocked_times %}
<div class="conflict-warning-box">
    <h2>{% blocktrans count counter=conflict_blocked_times|length %}Conflicting Blocked Time{% plural %}Conflicting Blocked Times ({{ counter }}){% endblocktrans %}</h2>
    <ul>
        {% for blocked_time in conflict_blocked_times %}
        <li class="conflict-list-item">
            <strong>{{ blocked_time.title }}</strong><br>
            <small>{{ blocked_time.start_datetime|date:"SHORT_DATETIME_FORMAT" }} - {{ blocked_time.end_datetime|date:"SHORT_DATETIME_FORMAT" }}</small>
            {% if blocked_time.description %}
            <br><small><em>{{ blocked_time.description }}</em></small>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if quota_conflicts %}
<div class="conflict-warning-box">
    <h2>üìä {% blocktrans count counter=quota_conflicts|length %}Contract Quota Conflict{% plural %}Contract Quota Conflicts ({{ counter }}){% endblocktrans %}</h2>
    <ul>
        {% for conflict in quota_conflicts %}
        <li class="conflict-list-item">
            <strong>{% trans "Contract quota exceeded" %}</strong><br>
            <small>{{ conflict.message }}</small>
            {% if conflict.planned_total is not None and conflict.actual_total is not None %}
            <br><small>
                {% blocktrans with planned=conflict.planned_total actual=conflict.actual_total month=conflict.month year=conflict.year %}
                Planned: {{ planned }} units | Actual: {{ actual }} units ({{ month }}/{{ year }})
                {% endblocktrans %}
            </small>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if not conflict_lessons and not conflict_blocked_times and not quota_conflicts %}
<div class="conflict-success-box">
    <p>{% trans "No conflicts found." %}</p>
</div>
{% endif %}

{% endblock %}
