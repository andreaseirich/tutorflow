{% extends 'core/base.html' %}
{% load i18n %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/lessons.css' %}">
{% endblock %}

{% block title %}{% blocktrans with date=lesson.date student=lesson.contract.student %}Lesson {{ date }} - {{ student }}{% endblocktrans %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans 'Lesson' %}</h1>

<div class="action-bar">
    <a href="{% url 'lessons:week' %}?year={{ lesson.date.year }}&month={{ lesson.date.month }}&day={{ lesson.date.day }}" class="btn">‚Üê {% trans 'Back to Calendar' %}</a>
    <a href="{% url 'lessons:update' lesson.pk %}" class="btn btn-primary">‚úèÔ∏è {% trans 'Edit' %}</a>
    <a href="{% url 'lessons:delete' lesson.pk %}" class="btn btn-danger">üóëÔ∏è {% trans 'Delete' %}</a>
</div>

<div class="panel">
    <h2>{% trans 'Details' %}</h2>
    <table class="table-simple">
        <tr>
            <td><strong>{% trans 'Date:' %}</strong></td>
            <td>{{ lesson.date|date:"d.m.Y" }}</td>
        </tr>
        <tr>
            <td><strong>{% trans 'Time:' %}</strong></td>
            <td>{% blocktrans with time=lesson.start_time|time:'H:i' minutes=lesson.duration_minutes %}{{ time }} ({{ minutes }} Min.){% endblocktrans %}</td>
        </tr>
        <tr>
            <td><strong>{% trans 'Student:' %}</strong></td>
            <td><a href="{% url 'students:detail' lesson.contract.student.pk %}">{{ lesson.contract.student.full_name }}</a></td>
        </tr>
        <tr>
            <td><strong>{% trans 'Status:' %}</strong></td>
            <td>{{ lesson.get_status_display }}</td>
        </tr>
        {% if lesson.travel_time_before_minutes or lesson.travel_time_after_minutes %}
        <tr>
            <td><strong>{% trans 'Travel Times:' %}</strong></td>
            <td>{% blocktrans with before=lesson.travel_time_before_minutes after=lesson.travel_time_after_minutes %}Before: {{ before }} Min. | After: {{ after }} Min.{% endblocktrans %}</td>
        </tr>
        {% endif %}
        {% if lesson.notes %}
        <tr>
            <td><strong>{% trans 'Notes:' %}</strong></td>
            <td>{{ lesson.notes }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if has_conflicts %}
<div class="panel panel-warning">
    <h2>‚ö† {% trans 'Conflicts' %}</h2>
    <p>
        <a href="{% url 'lessons:conflicts' lesson.pk %}" class="btn btn-conflict-details">{% trans 'Show Conflict Details' %}</a>
    </p>
    <div>
        <h4>{% trans 'Conflict Reasons:' %}</h4>
        <ul class="list-spaced">
            {% for conflict in conflicts %}
            <li>
                <strong>
                    {% if conflict.type == 'lesson' %}
                        ‚ö†Ô∏è {% trans 'Time overlap with another lesson' %}
                    {% elif conflict.type == 'blocked_time' %}
                        üö´ {% trans 'Time overlap with blocked time' %}
                    {% elif conflict.type == 'quota' %}
                        üìä {% trans 'Contract quota exceeded' %}
                    {% endif %}
                </strong>
                {% if conflict.type == 'lesson' and conflict.object %}
                    <br><small>{% trans 'Conflicting lesson:' %} <a href="{% url 'lessons:detail' conflict.object.pk %}">{{ conflict.object.contract.student.full_name }} - {{ conflict.object.date|date:'d.m.Y' }} {{ conflict.object.start_time|time:'H:i' }}</a></small>
                {% elif conflict.type == 'blocked_time' and conflict.object %}
                    <br><small>{% trans 'Blocked time:' %} {{ conflict.object.title }} ({{ conflict.object.start_datetime|date:'d.m.Y H:i' }} - {{ conflict.object.end_datetime|date:'H:i' }})</small>
                {% elif conflict.type == 'quota' %}
                    <br><small>{{ conflict.message }}</small>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    {% if conflict_lessons %}
    <h3>{% blocktrans count counter=conflict_lessons|length %}Conflicting Lesson{% plural %}Conflicting Lessons ({{ counter }}){% endblocktrans %}</h3>
    <table class="table-simple">
        <thead>
            <tr>
                <th>{% trans 'Date' %}</th>
                <th>{% trans 'Time' %}</th>
                <th>{% trans 'Student' %}</th>
                <th>{% trans 'Action' %}</th>
            </tr>
        </thead>
        <tbody>
            {% for conflict_lesson in conflict_lessons %}
            <tr>
                <td>{{ conflict_lesson.date|date:"d.m.Y" }}</td>
                <td>{{ conflict_lesson.start_time|time:"H:i" }}</td>
                <td>{{ conflict_lesson.contract.student.full_name }}</td>
                <td>
                    <a href="{% url 'lessons:detail' conflict_lesson.pk %}" class="btn btn-small">{% trans 'View' %}</a>
                    <a href="{% url 'lessons:update' conflict_lesson.pk %}" class="btn btn-primary btn-small">{% trans 'Edit' %}</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if conflict_blocked_times %}
    <h3>{% blocktrans count counter=conflict_blocked_times|length %}Conflicting Blocked Time{% plural %}Conflicting Blocked Times ({{ counter }}){% endblocktrans %}</h3>
    <ul class="list-spaced">
        {% for blocked_time in conflict_blocked_times %}
        <li>
            <strong>{{ blocked_time.title }}</strong><br>
            <small>{{ blocked_time.start_datetime|date:"SHORT_DATETIME_FORMAT" }} - {{ blocked_time.end_datetime|date:"SHORT_DATETIME_FORMAT" }}</small>
            {% if blocked_time.description %}
            <br><small><em>{{ blocked_time.description }}</em></small>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if quota_conflicts %}
    <h3 class="quota-exceeded-title">‚ö† {% blocktrans count counter=quota_conflicts|length %}Contract Quota Exceeded{% plural %}Contract Quota Exceeded ({{ counter }}){% endblocktrans %}</h3>
    <div class="panel panel-danger quota-exceeded-content">
        {% for quota_conflict in quota_conflicts %}
        <p class="quota-exceeded-text">
            <strong>{{ quota_conflict.message }}</strong><br>
            <small>
                {% blocktrans with planned=quota_conflict.planned_total actual=quota_conflict.actual_total %}Planned: {{ planned }} units | Actual: {{ actual }} hours{% endblocktrans %}
            </small>
        </p>
        {% endfor %}
        <p class="quota-exceeded-note">
            <strong>{% trans 'Note:' %}</strong> {% blocktrans with month=quota_conflicts.0.month|stringformat:'02d' year=quota_conflicts.0.year %}This lesson exceeds the planned quota until the end of {{ month }}.{{ year }}. Catching up is allowed, but pre-work is not.{% endblocktrans %}
        </p>
    </div>
    {% endif %}
</div>
{% endif %}

{% if is_premium %}
<div class="panel panel-info">
    <h2>ü§ñ {% trans 'AI Lesson Plan' %}</h2>
    {% if has_lesson_plan %}
    <p>{% trans 'A lesson plan has already been generated for this lesson.' %}</p>
    <div class="lesson-plan-section">
        <h4>{% trans 'Latest Lesson Plan:' %}</h4>
        <div class="panel lesson-plan-content">
            <p><strong>{% trans 'Topic:' %}</strong> {{ latest_lesson_plan.topic }}</p>
            <p><strong>{% trans 'Subject:' %}</strong> {{ latest_lesson_plan.subject }}</p>
            {% if latest_lesson_plan.grade_level %}
            <p><strong>{% trans 'Grade Level:' %}</strong> {{ latest_lesson_plan.grade_level }}</p>
            {% endif %}
            <div class="lesson-plan-text">{{ latest_lesson_plan.content }}</div>
            {% if latest_lesson_plan.llm_model %}
            <p class="muted lesson-plan-meta"><em>{% blocktrans with model=latest_lesson_plan.llm_model %}Generated with {{ model }}{% endblocktrans %}</em></p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    <form method="post" action="{% url 'ai:generate_lesson_plan' lesson.pk %}" class="lesson-plan-section">
        {% csrf_token %}
        <button type="submit" class="btn btn-generate-plan">
            {% if has_lesson_plan %}
                üîÑ {% trans 'Regenerate AI Lesson Plan' %}
            {% else %}
                ‚ú® {% trans 'Generate AI Lesson Plan' %}
            {% endif %}
        </button>
    </form>
</div>
{% else %}
<div class="panel panel-muted">
    <h2>ü§ñ {% trans 'AI Lesson Plan' %} <span class="premium-badge">{% trans 'Premium' %}</span></h2>
    <p>{% trans 'AI-powered lesson plan generation is only available for premium users.' %}</p>
    <button type="button" class="btn btn-secondary btn-disabled" disabled>
        ‚ú® {% trans 'Generate AI Lesson Plan' %}
    </button>
</div>
{% endif %}

{% endblock %}
