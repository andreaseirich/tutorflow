{% extends 'core/base.html' %}

{% block title %}Stunde {{ lesson.date }} - {{ lesson.contract.student }} - TutorFlow{% endblock %}

{% block content %}
<h1>Unterrichtsstunde</h1>

<div style="margin-bottom: 20px;">
    <a href="{% url 'lessons:calendar' %}?year={{ lesson.date.year }}&month={{ lesson.date.month }}" class="btn">‚Üê Zur√ºck zum Kalender</a>
    <a href="{% url 'lessons:update' lesson.pk %}" class="btn btn-primary">‚úèÔ∏è Bearbeiten</a>
    <a href="{% url 'lessons:delete' lesson.pk %}" class="btn btn-danger">üóëÔ∏è L√∂schen</a>
</div>

<div style="background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h2>Details</h2>
    <table style="width: 100%;">
        <tr>
            <td style="padding: 8px; font-weight: bold;">Datum:</td>
            <td style="padding: 8px;">{{ lesson.date|date:"d.m.Y" }}</td>
        </tr>
        <tr>
            <td style="padding: 8px; font-weight: bold;">Uhrzeit:</td>
            <td style="padding: 8px;">{{ lesson.start_time|time:"H:i" }} Uhr ({{ lesson.duration_minutes }} Min.)</td>
        </tr>
        <tr>
            <td style="padding: 8px; font-weight: bold;">Sch√ºler:</td>
            <td style="padding: 8px;">
                <a href="{% url 'students:detail' lesson.contract.student.pk %}">{{ lesson.contract.student.full_name }}</a>
            </td>
        </tr>
        <tr>
            <td style="padding: 8px; font-weight: bold;">Ort:</td>
            <td style="padding: 8px;">{{ lesson.location.name|default:"Nicht angegeben" }}</td>
        </tr>
        <tr>
            <td style="padding: 8px; font-weight: bold;">Status:</td>
            <td style="padding: 8px;">
                {% if lesson.status == 'planned' %}Geplant
                {% elif lesson.status == 'taught' %}Unterrichtet
                {% elif lesson.status == 'paid' %}Ausgezahlt
                {% elif lesson.status == 'cancelled' %}Ausgefallen
                {% else %}{{ lesson.status }}{% endif %}
            </td>
        </tr>
        {% if lesson.travel_time_before_minutes or lesson.travel_time_after_minutes %}
        <tr>
            <td style="padding: 8px; font-weight: bold;">Fahrtzeiten:</td>
            <td style="padding: 8px;">
                Vorher: {{ lesson.travel_time_before_minutes }} Min. | 
                Nachher: {{ lesson.travel_time_after_minutes }} Min.
            </td>
        </tr>
        {% endif %}
        {% if lesson.notes %}
        <tr>
            <td style="padding: 8px; font-weight: bold;">Notizen:</td>
            <td style="padding: 8px;">{{ lesson.notes }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if has_conflicts %}
<div style="background: #fff3cd; padding: 20px; border-radius: 5px; border-left: 4px solid #dc3545; margin-bottom: 20px;">
    <h2 style="color: #dc3545; margin-top: 0;">‚ö† Konflikte</h2>
    <p style="margin-bottom: 15px;">
        <a href="{% url 'lessons:conflicts' lesson.pk %}" class="btn" style="background: #dc3545; color: white;">
            Konflikt-Details anzeigen
        </a>
    </p>
    
    <h3>Kollidierende Unterrichtsstunden ({{ conflict_lessons|length }})</h3>
    {% if conflict_lessons %}
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Datum</th>
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Uhrzeit</th>
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Sch√ºler</th>
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Ort</th>
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Aktion</th>
            </tr>
        </thead>
        <tbody>
            {% for conflict_lesson in conflict_lessons %}
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">{{ conflict_lesson.date|date:"d.m.Y" }}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{{ conflict_lesson.start_time|time:"H:i" }} Uhr</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{{ conflict_lesson.contract.student.full_name }}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{{ conflict_lesson.location.name|default:"-" }}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <a href="{% url 'lessons:detail' conflict_lesson.pk %}" class="btn" style="font-size: 0.9em;">Anzeigen</a>
                    <a href="{% url 'lessons:update' conflict_lesson.pk %}" class="btn btn-primary" style="font-size: 0.9em;">Bearbeiten</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Keine kollidierenden Unterrichtsstunden.</p>
    {% endif %}
    
    {% if conflict_blocked_times %}
    <h3 style="margin-top: 20px;">Kollidierende Blockzeiten ({{ conflict_blocked_times|length }})</h3>
    <ul>
        {% for blocked_time in conflict_blocked_times %}
        <li>{{ blocked_time.title }} ({{ blocked_time.start_datetime|date:"d.m.Y H:i" }} - {{ blocked_time.end_datetime|date:"H:i" }})</li>
        {% endfor %}
    </ul>
    {% endif %}
    
    {% if quota_conflicts %}
    <h3 style="margin-top: 20px; color: #dc3545;">‚ö† Vertragskontingent √ºberschritten ({{ quota_conflicts|length }})</h3>
    <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin-top: 10px;">
        {% for quota_conflict in quota_conflicts %}
        <p style="margin: 5px 0; color: #721c24;">
            <strong>{{ quota_conflict.message }}</strong><br>
            <small>
                Geplant: {{ quota_conflict.planned_total }} Einheiten | 
                Tats√§chlich: {{ quota_conflict.actual_total }} Stunden
            </small>
        </p>
        {% endfor %}
        <p style="margin-top: 10px; font-size: 0.9em; color: #721c24;">
            <strong>Hinweis:</strong> Diese Stunde √ºberschreitet das geplante Kontingent bis Ende {{ quota_conflicts.0.month|stringformat:"02d" }}.{{ quota_conflicts.0.year }}.
            Nachholen ist erlaubt, aber Vorarbeiten nicht.
        </p>
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}
