{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% if object %}{% trans "Edit Lesson" %}{% else %}{% trans "New Lesson" %}{% endif %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% if object %}{% trans "Edit Lesson" %}{% else %}{% trans "New Lesson" %}{% endif %}</h1>

{% if object and matching_recurring %}
<div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; border: 1px solid #2196f3;">
    <h3>{% trans "This lesson is part of a series" %}</h3>
    <p><strong>{% trans "Series:" %}</strong> {{ matching_recurring.get_active_weekdays_display }}, {{ matching_recurring.start_time }} 
    ({% trans "Recurrence" %}: {{ matching_recurring.get_recurrence_type_display }})</p>
    <p><strong>{% trans "Series period:" %}</strong> {{ matching_recurring.start_date }} 
    {% if matching_recurring.end_date %}- {{ matching_recurring.end_date }}{% else %}({% trans "unlimited" %}){% endif %}</p>
    
    <div style="margin-top: 15px;">
        <label><strong>{% trans "What do you want to edit?" %}</strong></label>
        <div style="margin-top: 10px;">
            {% for choice in form.edit_scope %}
            <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                {{ choice.tag }}
                <span style="margin-left: 8px;">{{ choice.choice_label }}</span>
            </label>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="edit_scope" id="edit_scope_hidden" value="single">
    
    <div style="margin-bottom: 20px;">
        <h3>{% trans "Lesson Details" %}</h3>
        <p>
            <label for="{{ form.contract.id_for_label }}">{% trans "Contract:" %}</label>
            {{ form.contract }}
        </p>
        <p>
            <label for="{{ form.date.id_for_label }}">{% trans "Date:" %}</label>
            {{ form.date }}
        </p>
        <p>
            <label for="{{ form.start_time.id_for_label }}">{% trans "Start Time:" %}</label>
            {{ form.start_time }}
        </p>
        <p>
            <label for="{{ form.duration_minutes.id_for_label }}">{% trans "Duration (minutes):" %}</label>
            {{ form.duration_minutes }}
        </p>
        <p>
            <label for="{{ form.travel_time_before_minutes.id_for_label }}">{% trans "Travel Time Before (minutes):" %}</label>
            {{ form.travel_time_before_minutes }}
        </p>
        <p>
            <label for="{{ form.travel_time_after_minutes.id_for_label }}">{% trans "Travel Time After (minutes):" %}</label>
            {{ form.travel_time_after_minutes }}
        </p>
        <p>
            <label for="{{ form.notes.id_for_label }}">{% trans "Notes:" %}</label>
            {{ form.notes }}
        </p>
    </div>
    
    {% if not object %}
    <div id="recurrence-section" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; border: 1px solid #ddd;">
        <h3>{% trans "Recurrence (Optional)" %}</h3>
        <p>
            <label for="{{ form.is_recurring.id_for_label }}" style="display: flex; align-items: center; gap: 8px;">
                {{ form.is_recurring }}
                <strong>{% trans "Repeat this lesson" %}</strong>
            </label>
            {% if form.is_recurring.help_text %}
            <small style="display: block; margin-left: 28px; color: #666;">{{ form.is_recurring.help_text }}</small>
            {% endif %}
        </p>
        
        <div id="recurrence-fields" style="display: none; margin-top: 15px; margin-left: 28px;">
            <p>
                <label for="{{ form.recurrence_type.id_for_label }}">{% trans "Repeat pattern:" %}</label>
                {{ form.recurrence_type }}
            </p>
            <p>
                <label for="{{ form.recurrence_end_date.id_for_label }}">{% trans "End date (optional):" %}</label>
                {{ form.recurrence_end_date }}
                {% if form.recurrence_end_date.help_text %}
                <small style="display: block; color: #666;">{{ form.recurrence_end_date.help_text }}</small>
                {% endif %}
            </p>
            <p>
                <label>{% trans "Weekdays:" %}</label>
                <div id="weekdays-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                    {% for choice in form.recurrence_weekdays %}
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        {{ choice.tag }}
                        <span>{{ choice.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% if form.recurrence_weekdays.help_text %}
                <small style="display: block; color: #666;">{{ form.recurrence_weekdays.help_text }}</small>
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}
    
    {% if object and matching_recurring %}
    <div id="series-info" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffc107; display: none;">
        <h3>{% trans "Series Settings" %}</h3>
        <p><em>{% trans "When editing the entire series, changes to the following fields will be applied to all lessons in the series:" %}</em></p>
        
        <div style="margin-top: 15px;">
            <p><strong>{% trans "Current series configuration:" %}</strong></p>
            <ul>
                <li>{% trans "Recurrence type" %}: {{ matching_recurring.get_recurrence_type_display }}</li>
                <li>{% trans "Weekdays" %}: {{ matching_recurring.get_active_weekdays_display }}</li>
                <li>{% trans "Series period" %}: {{ matching_recurring.start_date }} {% if matching_recurring.end_date %}- {{ matching_recurring.end_date }}{% else %}({% trans "unlimited" %}){% endif %}</li>
            </ul>
        </div>
        
        <div id="series-weekdays-section" style="margin-top: 15px; display: none;">
            <p>
                <label><strong>{% trans "Change weekdays:" %}</strong></label>
                <div id="series-weekdays-container" style="display: none; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                    {# Erstelle Checkboxes immer manuell basierend auf matching_recurring #}
                    {% if matching_recurring %}
                        {% with active_weekdays=matching_recurring.get_active_weekdays %}
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="0" {% if 0 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-0">
                            <span>{% trans "Monday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="1" {% if 1 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-1">
                            <span>{% trans "Tuesday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="2" {% if 2 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-2">
                            <span>{% trans "Wednesday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="3" {% if 3 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-3">
                            <span>{% trans "Thursday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="4" {% if 4 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-4">
                            <span>{% trans "Friday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="5" {% if 5 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-5">
                            <span>{% trans "Saturday" %}</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; margin-bottom: 5px;">
                            <input type="checkbox" name="recurrence_weekdays" value="6" {% if 6 in active_weekdays %}checked{% endif %} class="form-check-input" id="weekday-6">
                            <span>{% trans "Sunday" %}</span>
                        </label>
                        {% endwith %}
                    {% endif %}
                </div>
                <small style="display: block; color: #666; margin-top: 10px;">{% trans "Select the weekdays for this series. Lessons on deselected weekdays will be deleted, and new lessons will be created for newly selected weekdays." %}</small>
            </p>
        </div>
    </div>
    {% endif %}

    <div class="btn-group">
        <button type="submit" class="btn btn-success">{% trans "Save" %}</button>
        <a href="{% url 'lessons:calendar' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
</form>

<script>
function toggleRecurrenceFields() {
    const isRecurring = document.getElementById('{{ form.is_recurring.id_for_label }}');
    const recurrenceFields = document.getElementById('recurrence-fields');
    const weekdaysContainer = document.getElementById('weekdays-container');
    if (isRecurring && recurrenceFields) {
        if (isRecurring.checked) {
            recurrenceFields.style.display = 'block';
            // Show recurrence fields
            const recurrenceType = document.getElementById('{{ form.recurrence_type.id_for_label }}');
            const recurrenceEndDate = document.getElementById('{{ form.recurrence_end_date.id_for_label }}');
            if (recurrenceType) recurrenceType.style.display = 'block';
            if (recurrenceEndDate) recurrenceEndDate.style.display = 'block';
            // Show weekdays checkboxes
            if (weekdaysContainer) {
                weekdaysContainer.style.display = 'flex';
                // Make sure all checkboxes are visible and enabled
                const checkboxes = weekdaysContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(function(checkbox) {
                    checkbox.style.display = 'inline-block';
                    checkbox.disabled = false;
                    checkbox.style.pointerEvents = 'auto';
                });
            }
        } else {
            recurrenceFields.style.display = 'none';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleRecurrenceFields();
    
    // Function to show/hide series info
    function toggleSeriesInfo(show) {
        const seriesInfo = document.getElementById('series-info');
        const seriesWeekdaysSection = document.getElementById('series-weekdays-section');
        const seriesWeekdaysContainer = document.getElementById('series-weekdays-container');
        
        if (show) {
            if (seriesInfo) {
                seriesInfo.style.display = 'block';
            }
            if (seriesWeekdaysSection) {
                seriesWeekdaysSection.style.display = 'block';
            }
            // Show weekday checkboxes
            if (seriesWeekdaysContainer) {
                seriesWeekdaysContainer.style.display = 'flex';
                // Ensure all checkboxes are visible and enabled
                const checkboxes = seriesWeekdaysContainer.querySelectorAll('input[type="checkbox"]');
                if (checkboxes.length > 0) {
                    checkboxes.forEach(function(checkbox) {
                        // Remove all hiding styles and attributes
                        checkbox.removeAttribute('hidden');
                        checkbox.style.display = '';
                        checkbox.style.visibility = '';
                        checkbox.style.opacity = '';
                        checkbox.classList.remove('hidden');
                        // Set explicitly visible
                        checkbox.style.display = 'inline-block';
                        checkbox.style.visibility = 'visible';
                        checkbox.style.opacity = '1';
                        checkbox.disabled = false;
                        checkbox.readOnly = false;
                        checkbox.style.pointerEvents = 'auto';
                    });
                    // Ensure labels are visible
                    const labels = seriesWeekdaysContainer.querySelectorAll('label');
                    labels.forEach(function(label) {
                        label.removeAttribute('hidden');
                        label.style.display = '';
                        label.style.visibility = '';
                        label.style.opacity = '';
                        label.classList.remove('hidden');
                        label.style.display = 'flex';
                        label.style.visibility = 'visible';
                        label.style.opacity = '1';
                    });
                }
            }
        } else {
            if (seriesInfo) {
                seriesInfo.style.display = 'none';
            }
            if (seriesWeekdaysSection) {
                seriesWeekdaysSection.style.display = 'none';
            }
        }
    }
    
    // Show/hide series info based on edit_scope
    function setupEditScopeToggle() {
        const editScopeRadios = document.querySelectorAll('input[name="edit_scope"]');
        
        if (editScopeRadios.length > 0) {
            editScopeRadios.forEach(function(radio) {
                // Remove old event listeners if present
                const newRadio = radio.cloneNode(true);
                radio.parentNode.replaceChild(newRadio, radio);
                
                // Add event listeners (both change and click)
                newRadio.addEventListener('change', handleEditScopeChange);
                newRadio.addEventListener('click', handleEditScopeChange);
            });
            
            // Initial state - check immediately on load
            const checkedRadio = document.querySelector('input[name="edit_scope"]:checked');
            if (checkedRadio) {
                handleEditScopeChange.call(checkedRadio);
            }
        }
    }
    
    function handleEditScopeChange() {
        const isSeries = this.value === 'series';
        const hiddenField = document.getElementById('edit_scope_hidden');
        if (hiddenField) {
            hiddenField.value = this.value;
        }
        toggleSeriesInfo(isSeries);
    }
    
    // Initialize on DOM load
    setupEditScopeToggle();
    
    // Ensure date fields display initial values
    function initializeDateFields() {
        const urlParams = new URLSearchParams(window.location.search);
        const dateField = document.getElementById('{{ form.date.id_for_label }}');
        const timeField = document.getElementById('{{ form.start_time.id_for_label }}');
        
        // Support for start parameter (ISO datetime format: YYYY-MM-DDTHH:MM)
        const startParam = urlParams.get('start');
        if (startParam) {
            try {
                // Parse ISO format: YYYY-MM-DDTHH:MM (treat as local time, not UTC)
                // If format is YYYY-MM-DDTHH:MM, parse it directly to avoid timezone conversion
                if (startParam.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                    // Parse as local time explicitly
                    const [datePart, timePart] = startParam.split('T');
                    const [year, month, day] = datePart.split('-').map(Number);
                    const [hours, minutes] = timePart.split(':').map(Number);
                    
                    // Set date
                    if (dateField) {
                        dateField.value = datePart;
                    }
                    // Set time
                    if (timeField) {
                        timeField.value = timePart;
                    }
                } else {
                    // Fallback: use Date constructor (for other formats)
                    const startDate = new Date(startParam);
                    if (!isNaN(startDate.getTime())) {
                        // Set date
                        if (dateField) {
                            const year = startDate.getFullYear();
                            const month = String(startDate.getMonth() + 1).padStart(2, '0');
                            const day = String(startDate.getDate()).padStart(2, '0');
                            dateField.value = `${year}-${month}-${day}`;
                        }
                        // Set time
                        if (timeField) {
                            const hours = String(startDate.getHours()).padStart(2, '0');
                            const minutes = String(startDate.getMinutes()).padStart(2, '0');
                            timeField.value = `${hours}:${minutes}`;
                        }
                    }
                }
            } catch (e) {
                // Failed to parse start parameter
            }
        }
        
        // Fallback: date field for lesson (if not yet set)
        if (dateField && !dateField.value) {
            // Try to read date from GET parameters
            const dateParam = urlParams.get('date');
            if (dateParam) {
                // Convert YYYY-MM-DD format
                dateField.value = dateParam;
            } else {
                // Try to construct from year/month/day parameters
                const year = urlParams.get('year');
                const month = urlParams.get('month');
                const day = urlParams.get('day') || '1';
                if (year && month) {
                    const formattedDate = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    dateField.value = formattedDate;
                }
            }
        }
        
        // Fallback: time field (if not yet set)
        if (timeField && !timeField.value) {
            const timeParam = urlParams.get('time');
            if (timeParam) {
                timeField.value = timeParam;
            }
        }
        
        // Recurrence end date
        const recurrenceEndDateField = document.getElementById('{{ form.recurrence_end_date.id_for_label }}');
        if (recurrenceEndDateField && !recurrenceEndDateField.value && dateField && dateField.value) {
            // Set end date to 1 year after start date as default
            const startDate = new Date(dateField.value);
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            recurrenceEndDateField.value = endDate.toISOString().split('T')[0];
        }
    }
    
    // Initialize date fields on load
    initializeDateFields();
});
</script>
{% endblock %}

