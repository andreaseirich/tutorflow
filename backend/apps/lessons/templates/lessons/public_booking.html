{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% get_available_languages as LANGUAGES %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% trans "Book Lesson" %}</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
            color: #2c3e50; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        h1 { color: #2c3e50; margin-top: 0; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.2s; 
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .message { 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            border-left: 4px solid; 
        }
        .message.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .message.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .step { 
            display: none; 
            margin: 20px 0; 
        }
        .step.active { display: block; }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        .form-group textarea { 
            min-height: 100px; 
        }
        .similar-students { 
            margin: 15px 0; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
        }
        .similar-student { 
            padding: 10px; 
            margin: 5px 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .similar-student:hover { 
            background: #e3f2fd; 
        }
        .time-slots { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 10px; 
            margin: 15px 0; 
        }
        .time-slot { 
            padding: 10px; 
            border: 2px solid #007bff; 
            border-radius: 4px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: white; 
        }
        .time-slot:hover { 
            background: #e3f2fd; 
            transform: scale(1.05); 
        }
        .time-slot.occupied { 
            background: #f8d7da; 
            border-color: #dc3545; 
            cursor: not-allowed; 
            opacity: 0.6; 
        }
        .time-slot.own-lesson { 
            background: #d4edda; 
            border-color: #28a745; 
        }
        .time-slot.reschedulable { 
            cursor: pointer; 
        }
        .time-slot.reschedulable:hover { 
            opacity: 1; 
        }
        .time-slot.reschedule-selected { 
            border-width: 3px; 
            border-color: #ffc107; 
            box-shadow: 0 0 0 2px #ffc107; 
        }
        .time-slot.selected { 
            background: #fff3cd; 
            border-color: #ffc107; 
            border-width: 3px; 
        }
        .day-column { 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px; 
            background: white; 
        }
        .day-header { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin-bottom: 15px; 
            color: #2c3e50; 
        }
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            padding: 0;
        }
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 0 5px;
        }
        .progress-step.active {
            background: #007bff;
            color: white;
        }
        .progress-step.completed {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h1 style="margin: 0;">{% trans "Book Lesson" %}</h1>
            <form action="{% url 'set_language' %}" method="post" style="margin: 0;">
                {% csrf_token %}
                <input name="next" type="hidden" value="{{ request.get_full_path }}">
                <select name="language" onchange="this.form.submit()" title="{% trans 'Language' %}" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                    {% for lang_code, lang_name in LANGUAGES %}
                    <option value="{{ lang_code }}" {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>{% if lang_code == 'de' %}DE{% elif lang_code == 'en' %}EN{% else %}{{ lang_code|upper }}{% endif %}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div id="messages"></div>
        
        <div class="progress-indicator">
            <div class="progress-step active" id="step-indicator-1">1. {% trans "Name" %}</div>
            <div class="progress-step" id="step-indicator-2">2. {% trans "Data" %}</div>
            <div class="progress-step" id="step-indicator-3">3. {% trans "Time Slot" %}</div>
            <div class="progress-step" id="step-indicator-4">4. {% trans "Confirm" %}</div>
        </div>
        
        <!-- Schritt 1: Name eingeben -->
        <div class="step active" id="step-1">
            <h2>{% trans "Enter your name" %}</h2>
            <div class="form-group">
                <label for="student-name">{% trans "Full Name" %}</label>
                <input type="text" id="student-name" placeholder="{% trans 'e.g., Max Mustermann' %}" required>
            </div>
            <div id="step-1-search-result" style="display: none;">
                <div id="step-1-suggestions" class="similar-students" style="margin: 15px 0; display: none;"></div>
                <div id="step-1-no-match" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <p>{% trans "No matching student found." %}</p>
                    <button type="button" class="btn" onclick="goToCreateNew()">{% trans "Create new student profile" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="clearSearchResult()">{% trans "Try again" %}</button>
                </div>
            </div>
            <button class="btn" id="step-1-continue-btn" onclick="searchStudent()">{% trans "Continue" %}</button>
        </div>
        
        <!-- Schritt 2: Code eingeben oder neu anlegen -->
        <div class="step" id="step-2-code">
            <h2>{% trans "Enter your booking code" %}</h2>
            <p id="step-2-code-intro">{% trans "Your tutor has given you a code. Enter it here." %}</p>
            <div class="form-group">
                <label for="booking-code">{% trans "Booking Code" %}</label>
                <input type="text" id="booking-code" placeholder="{% trans 'e.g., ABC123XYZ456' %}" autocomplete="off">
            </div>
            <button class="btn" onclick="verifyStudent()">{% trans "Verify" %}</button>
            <p style="margin-top: 20px;">{% trans "Don't have a code?" %}</p>
            <button type="button" class="btn btn-secondary" onclick="goToCreateNew()">{% trans "Create new student profile" %}</button>
            <button type="button" class="btn btn-secondary" onclick="goToStep(1)" style="margin-left: 10px;">{% trans "Back" %}</button>
        </div>
        
        <!-- Schritt 2a: Neuer Schüler -->
        <div class="step" id="step-2a">
            <h2>{% trans "Create New Student" %}</h2>
            <form id="new-student-form">
                <div class="form-group">
                    <label for="first-name">{% trans "First Name" %} *</label>
                    <input type="text" id="first-name" required>
                </div>
                <div class="form-group">
                    <label for="last-name">{% trans "Last Name" %} *</label>
                    <input type="text" id="last-name" required>
                </div>
                <div class="form-group">
                    <label for="email">{% trans "Email" %}</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="phone">{% trans "Phone" %}</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="school">{% trans "School" %}</label>
                    <input type="text" id="school">
                </div>
                <div class="form-group">
                    <label for="grade">{% trans "Grade" %}</label>
                    <input type="text" id="grade">
                </div>
                <div class="form-group">
                    <label for="subjects">{% trans "Subjects" %}</label>
                    <input type="text" id="subjects" placeholder="{% trans 'e.g., Math, German' %}">
                </div>
                <div class="form-group">
                    <label for="institute">{% trans "Institute" %}</label>
                    <input type="text" id="institute">
                    <small>{% trans "Leave empty if no institute" %}</small>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToStep('2-code')">{% trans "Back" %}</button>
                <button type="button" class="btn btn-success" onclick="createStudent()">{% trans "Continue" %}</button>
            </form>
        </div>
        
        <!-- Schritt 2b: Bestehender Schüler - Buchungsformular -->
        <div class="step" id="step-2b">
            <h2>{% trans "Book Lesson" %} - <span id="student-name-display"></span></h2>
            <form id="booking-form">
                <div class="form-group">
                    <label for="subject">{% trans "Subject" %}</label>
                    <input type="text" id="subject" placeholder="{% trans 'e.g., Math' %}">
                </div>
                <div class="form-group">
                    <label for="booking-notes">{% trans "Notes" %}</label>
                    <textarea id="booking-notes" placeholder="{% trans 'Additional notes for the lesson...' %}"></textarea>
                </div>
                <div class="form-group">
                    <label for="documents">{% trans "Upload Documents" %}</label>
                    <input type="file" id="documents" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
                    <small>{% trans "You can upload multiple files (PDF, DOC, DOCX, TXT, JPG, PNG, max 10 MB each)" %}</small>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToStep('2-code')">{% trans "Back" %}</button>
                <button type="button" class="btn btn-success" onclick="goToStep(3)">{% trans "Continue" %}</button>
            </form>
        </div>
        
        <!-- Schritt 3: Zeitslot-Auswahl -->
        <div class="step" id="step-3">
            <h2>{% trans "Select Time Slot" %}</h2>
            <div class="btn-group">
                <button class="btn" onclick="previousWeek()">← {% trans "Previous Week" %}</button>
                <button class="btn" onclick="nextWeek()">{% trans "Next Week" %} →</button>
            </div>
            <div id="selected-slots-info" style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 4px; display: none;">
                <strong>{% trans "Selected:" %}</strong> <span id="selected-range"></span>
                <button class="btn btn-secondary" onclick="clearSelection()" style="margin-left: 10px;">{% trans "Clear Selection" %}</button>
            </div>
            <div id="inline-reschedule-banner" style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 4px; border: 1px solid #2196f3; display: none;">
                <p id="inline-reschedule-text" style="margin: 0 0 8px 0;"></p>
                <button type="button" class="btn btn-success" id="inline-reschedule-confirm-btn" onclick="confirmInlineReschedule()" style="display: none; margin-right: 8px;">{% trans "Confirm Reschedule" %}</button>
                <button type="button" class="btn btn-secondary" onclick="cancelInlineReschedule()">{% trans "Cancel" %}</button>
            </div>
            <div id="public-week-loading" style="display: none; text-align: center; padding: 20px; color: #6c757d;">{% trans "Loading..." %}</div>
            <div class="week-calendar">
                <div id="public-week-calendar-days">
                {% for day in week_data.days %}
                <div class="day-column">
                    <div class="day-header">
                        {{ day.weekday_display }}, {{ day.date|date:"SHORT_DATE_FORMAT" }}
                    </div>
                    
                    {% if day.working_hours %}
                        <div class="time-slots">
                            {% for slot in day.available_slots %}
                            <div class="time-slot" 
                                 data-date="{{ day.date|date:'Y-m-d' }}" 
                                 data-start="{{ slot.0|time:'H:i' }}" 
                                 data-end="{{ slot.1|time:'H:i' }}"
                                 onclick="toggleSlot(this)">
                                <div class="time-slot-label">
                                    {{ slot.0|time:'H:i' }}
                                </div>
                            </div>
                            {% endfor %}
                            {% if day.busy_intervals %}
                            {% for bi in day.busy_intervals %}
                            <div class="time-slot occupied {% if bi.own %}own-lesson{% endif %} {% if bi.reschedulable %}reschedulable{% endif %}"
                                 {% if bi.reschedulable %}data-lesson-id="{{ bi.lesson_id }}" data-date="{{ day.date|date:'Y-m-d' }}" data-start="{{ bi.start }}" data-end="{{ bi.end }}" onclick="tapOnReschedulableEntry(this)"{% endif %}>
                                <div class="time-slot-label">{{ bi.start }} - {{ bi.end }}</div>
                                <div class="occupied-label">{% if bi.own %}{{ bi.label }}{% if bi.reschedulable %} ({% trans "tap to reschedule" %}){% endif %}{% else %}{% trans "Booked" %}{% endif %}</div>
                            </div>
                            {% endfor %}
                            {% else %}
                            {% for occupied in day.occupied_slots %}
                            <div class="time-slot occupied">
                                <div class="time-slot-label">
                                    {{ occupied.0|time:'H:i' }} - {{ occupied.1|time:'H:i' }}
                                </div>
                                <div class="occupied-label">{% trans "Occupied" %}</div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    {% else %}
                        <p style="color: #6c757d;">{% trans "No working hours configured for this day." %}</p>
                    {% endif %}
                </div>
                {% endfor %}
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="goToStep(2)">{% trans "Back" %}</button>
            <button type="button" class="btn btn-success" onclick="goToStep(4)" id="continue-to-confirm" disabled>{% trans "Continue to Confirm" %}</button>
        </div>
        
        <!-- Schritt 4: Bestätigung -->
        <div class="step" id="step-4">
            <h2>{% trans "Confirm Booking" %}</h2>
            <div id="booking-summary"></div>
            <button type="button" class="btn btn-secondary" onclick="goToStep(3)">{% trans "Back" %}</button>
            <button type="button" class="btn btn-success" onclick="confirmBooking()">{% trans "Confirm and Book" %}</button>
        </div>
        
    </div>
    
    <script>
        const currentYear = {{ current_date.year }};
        const currentMonth = {{ current_date.month }};
        const currentDay = {{ current_date.day }};
        const TUTOR_TOKEN = "{{ tutor_token|default:''|escapejs }}";
        
        let currentStudent = null;
        let currentBookingCode = null;
        let selectedStudentName = null;
        let selectedStudentId = null;
        let selectedSlots = [];
        let currentDate = null;
        let bookingData = {};
        let inlineRescheduleLessonId = null;
        let inlineRescheduleLessonInfo = null;
        let inlineRescheduleSelectedSlot = null;
        
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }
        
        function goToStep(stepId) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            var stepEl = document.getElementById('step-' + stepId);
            if (stepEl) stepEl.classList.add('active');
            
            var stepNum = (stepId === 1) ? 1 : (stepId === '2-code' || stepId === '2a' || stepId === '2b') ? 2 : (stepId === 3) ? 3 : (stepId === 4) ? 4 : 1;
            document.querySelectorAll('.progress-step').forEach(function(step, index) {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNum) step.classList.add('completed');
                else if (index + 1 === stepNum) step.classList.add('active');
            });
            
            if (stepId === 1) { selectedStudentName = null; selectedStudentId = null; clearSearchResult(); }
            if (stepId === '2-code' && selectedStudentName) {
                var intro = document.getElementById('step-2-code-intro');
                if (intro) intro.textContent = '{% trans "Enter the code for" %} ' + selectedStudentName;
            }
            if (stepId === 4) updateBookingSummary();
            if (stepId === 3) {
                if (currentStudent) loadWeek(currentYear, currentMonth, currentDay);
                updateContinueButton();
            }
        }
        
        function verifyStudent() {
            var name = selectedStudentName || document.getElementById('student-name').value.trim();
            var code = document.getElementById('booking-code').value.trim();
            if (!code) { showMessage('{% trans "Please enter the booking code." %}', 'error'); return; }
            if (!selectedStudentId && !name) { showMessage('{% trans "Please enter your name or select a student." %}', 'error'); return; }
            var payload = { code: code, tutor_token: TUTOR_TOKEN };
            if (selectedStudentId) payload.student_id = selectedStudentId;
            if (name) payload.name = name;
            fetch('{% url "lessons:public_booking_verify_student" %}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
            .then(function(result) {
                if (result.data.success && result.data.student) {
                    currentStudent = result.data.student;
                    currentBookingCode = code;
                    document.getElementById('student-name-display').textContent = result.data.student.full_name;
                    goToStep('2b');
                } else {
                    showMessage(result.data.message || '{% trans "Invalid name or code. Please try again." %}', 'error');
                }
            })
            .catch(function() {
                showMessage('{% trans "Invalid name or code. Please try again." %}', 'error');
            });
        }
        
        function searchStudent() {
            var name = document.getElementById('student-name').value.trim();
            if (!name) { showMessage('{% trans "Please enter your name." %}', 'error'); return; }
            var btn = document.getElementById('step-1-continue-btn');
            btn.disabled = true;
            fetch('{% url "lessons:public_booking_search_student" %}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                body: JSON.stringify({ name: name, tutor_token: TUTOR_TOKEN })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                if (!data.success) { showMessage(data.message || '{% trans "Error." %}', 'error'); return; }
                var suggEl = document.getElementById('step-1-suggestions');
                var noMatchEl = document.getElementById('step-1-no-match');
                var resultEl = document.getElementById('step-1-search-result');
                suggEl.style.display = 'none';
                noMatchEl.style.display = 'none';
                resultEl.style.display = 'block';
                if (data.result === 'exact_match') {
                    selectedStudentName = data.student.display_name;
                    selectedStudentId = data.student.id;
                    goToStep('2-code');
                } else if (data.result === 'suggestions' && data.suggestions && data.suggestions.length > 0) {
                    lastSuggestions = data.suggestions;
                    var html = '<p>{% trans "Did you mean one of these?" %}</p>';
                    data.suggestions.forEach(function(s, idx) {
                        html += '<div class="similar-student" data-idx="' + idx + '" onclick="selectSuggestionByIdx(' + idx + ')">' + escapeHtml(s.display_name) + '</div>';
                    });
                    html += '<div class="similar-student" style="border: 2px dashed #007bff;" onclick="goToCreateNew()"><strong>{% trans "Create new student" %}: ' + escapeHtml(name) + '</strong></div>';
                    suggEl.innerHTML = html;
                    suggEl.style.display = 'block';
                } else {
                    noMatchEl.style.display = 'block';
                }
            })
            .catch(function() { btn.disabled = false; showMessage('{% trans "Error. Please try again." %}', 'error'); });
        }
        function escapeHtml(s) {
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        var lastSuggestions = [];
        function selectSuggestionByIdx(idx) {
            var s = lastSuggestions[idx];
            if (s) {
                selectedStudentName = s.display_name;
                selectedStudentId = s.id;
                goToStep('2-code');
            }
        }
        function clearSearchResult() {
            document.getElementById('step-1-search-result').style.display = 'none';
            document.getElementById('step-1-suggestions').innerHTML = '';
            document.getElementById('step-1-suggestions').style.display = 'none';
            document.getElementById('step-1-no-match').style.display = 'none';
        }
        function goToCreateNew() {
            var name = selectedStudentName || document.getElementById('student-name').value.trim();
            selectedStudentName = null;
            selectedStudentId = null;
            var parts = name.split(/\s+/);
            if (parts.length >= 2) {
                document.getElementById('last-name').value = parts.pop();
                document.getElementById('first-name').value = parts.join(' ');
            } else if (parts.length === 1) {
                document.getElementById('first-name').value = parts[0];
                document.getElementById('last-name').value = '';
            } else {
                document.getElementById('first-name').value = '';
                document.getElementById('last-name').value = '';
            }
            goToStep('2a');
        }
        
        function createStudent() {
            const formData = {
                first_name: document.getElementById('first-name').value.trim(),
                last_name: document.getElementById('last-name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                school: document.getElementById('school').value.trim(),
                grade: document.getElementById('grade').value.trim(),
                subjects: document.getElementById('subjects').value.trim(),
                institute: document.getElementById('institute').value.trim(),
                tutor_token: TUTOR_TOKEN
            };
            
            if (!formData.first_name || !formData.last_name) {
                showMessage('{% trans "First name and last name are required." %}', 'error');
                return;
            }
            
            var url = '{% url "lessons:public_booking_create_student" %}';
            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                body: JSON.stringify(formData)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    currentStudent = data.student;
                    currentBookingCode = data.booking_code || null;
                    document.getElementById('student-name-display').textContent = data.student.full_name;
                    if (data.booking_code) {
                        alert('{% trans "Save this code for next time" %}: ' + data.booking_code);
                    }
                    goToStep('2b');
                } else {
                    showMessage(data.message || '{% trans "Error creating student." %}', 'error');
                }
            })
            .catch(function() {
                showMessage('{% trans "Error creating student. Please try again." %}', 'error');
            });
        }
        
        function toggleSlot(element) {
            if (element.classList.contains('occupied')) return;
            var date = element.dataset.date, startTime = element.dataset.start, endTime = element.dataset.end;
            if (inlineRescheduleLessonId) {
                inlineRescheduleSelectedSlot = { date: date, start: startTime, end: endTime };
                document.querySelectorAll('#public-week-calendar-days .time-slot.selected').forEach(function(el) { el.classList.remove('selected'); });
                element.classList.add('selected');
                document.getElementById('inline-reschedule-text').textContent = '{% trans "New time:" %} ' + date + ' ' + startTime + ' - ' + endTime;
                document.getElementById('inline-reschedule-confirm-btn').style.display = 'inline-block';
                return;
            }
            var slotKey = date + '_' + startTime;
            if (selectedSlots.length === 1 && selectedSlots[0].key === slotKey) {
                clearSelection();
                return;
            }
            clearSelection();
            selectedSlots = [{ key: slotKey, date: date, startTime: startTime, endTime: endTime }];
            element.classList.add('selected');
            currentDate = date;
            updateSelectionInfo();
            updateContinueButton();
        }
        
        function updateSelectionInfo() {
            var infoDiv = document.getElementById('selected-slots-info'), rangeSpan = document.getElementById('selected-range');
            if (selectedSlots.length === 0) { infoDiv.style.display = 'none'; return; }
            var s = selectedSlots[0];
            rangeSpan.textContent = s.date + ' ' + s.startTime + ' - ' + s.endTime;
            infoDiv.style.display = 'block';
        }
        
        function clearSelection() {
            selectedSlots.forEach(slot => {
                const element = document.querySelector(`[data-date="${slot.date}"][data-start="${slot.startTime}"]`);
                if (element) {
                    element.classList.remove('selected');
                }
            });
            selectedSlots = [];
            currentDate = null;
            updateSelectionInfo();
            updateContinueButton();
        }
        
        function updateContinueButton() {
            const btn = document.getElementById('continue-to-confirm');
            if (selectedSlots.length > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        function updateBookingSummary() {
            const summaryDiv = document.getElementById('booking-summary');
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            bookingData = {
                student_id: currentStudent.id,
                date: firstSlot.date,
                start_time: firstSlot.startTime,
                end_time: lastSlot.endTime,
                subject: document.getElementById('subject').value.trim(),
                notes: document.getElementById('booking-notes').value.trim(),
                institute: document.getElementById('institute') ? document.getElementById('institute').value.trim() : ''
            };
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 4px;">';
            html += `<p><strong>{% trans "Student" %}:</strong> ${currentStudent.full_name}</p>`;
            html += `<p><strong>{% trans "Date" %}:</strong> ${firstSlot.date}</p>`;
            html += `<p><strong>{% trans "Time" %}:</strong> ${firstSlot.startTime} - ${lastSlot.endTime}</p>`;
            if (bookingData.subject) {
                html += `<p><strong>{% trans "Subject" %}:</strong> ${bookingData.subject}</p>`;
            }
            if (bookingData.notes) {
                html += `<p><strong>{% trans "Notes" %}:</strong> ${bookingData.notes}</p>`;
            }
            const files = document.getElementById('documents').files;
            if (files.length > 0) {
                html += `<p><strong>{% trans "Documents" %}:</strong> ${files.length} {% trans "file(s)" %}</p>`;
            }
            html += '</div>';
            
            summaryDiv.innerHTML = html;
        }
        
        function confirmBooking() {
            if (!currentStudent || selectedSlots.length === 0) {
                showMessage('{% trans "Please complete all steps." %}', 'error');
                return;
            }
            if (!currentBookingCode) {
                showMessage('{% trans "Booking code is required. Please go back and verify again." %}', 'error');
                return;
            }
            
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            if (firstSlot.date !== lastSlot.date) {
                showMessage('{% trans "All selected slots must be on the same day." %}', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', currentStudent.id);
            formData.append('booking_code', currentBookingCode);
            formData.append('tutor_token', TUTOR_TOKEN);
            formData.append('date', firstSlot.date);
            formData.append('start_time', firstSlot.startTime);
            formData.append('end_time', lastSlot.endTime);
            formData.append('subject', document.getElementById('subject').value.trim());
            formData.append('notes', document.getElementById('booking-notes').value.trim());
            const instituteInput = document.getElementById('institute');
            if (instituteInput) {
                formData.append('institute', instituteInput.value.trim());
            }
            
            const files = document.getElementById('documents').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            const url = '{% url "lessons:public_booking_book_lesson" %}';
            const options = {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                body: formData
            };
            
            // Note: apiRequest helper doesn't work with FormData, so use fetch directly with improved error handling
            fetch(url, options)
            .then(async response => {
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = response.statusText || '{% trans "Server error" %}';
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(function() {
                        currentStudent = null;
                        currentBookingCode = null;
                        selectedSlots = [];
                        document.getElementById('student-name').value = '';
                        document.getElementById('booking-code').value = '';
                        document.getElementById('new-student-form').reset();
                        document.getElementById('booking-form').reset();
                        clearSelection();
                        goToStep(1);
                    }, 2000);
                } else {
                    showMessage(data.message || '{% trans "Error booking lesson." %}', 'error');
                }
            })
            .catch(error => {
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showMessage('{% trans "Network error: Please check your internet connection." %}', 'error');
                } else {
                    showMessage(error.message || '{% trans "Error booking lesson. Please try again." %}', 'error');
                }
            });
        }
        
        function loadWeek(year, month, day) {
            if (!TUTOR_TOKEN) return;
            const loadingEl = document.getElementById('public-week-loading');
            const daysEl = document.getElementById('public-week-calendar-days');
            loadingEl.style.display = 'block';
            daysEl.style.opacity = '0.5';

            const url = '/lessons/public-booking/' + encodeURIComponent(TUTOR_TOKEN) + '/week/?year=' + year + '&month=' + month + '&day=' + day;

            fetch(url)
                .then(function(response) {
                    return response.json().then(function(data) {
                        return { ok: response.ok, data: data };
                    });
                })
                .then(function(result) {
                    loadingEl.style.display = 'none';
                    daysEl.style.opacity = '1';
                    if (result.ok && result.data && result.data.success && result.data.week_data) {
                        var msgEl = document.getElementById('messages');
                        if (msgEl) msgEl.innerHTML = '';
                        renderWeekCalendar(result.data.week_data);
                        currentYear = year;
                        currentMonth = month;
                        currentDay = day;
                        clearSelection();
                        updateContinueButton();
                        var newUrl = window.location.pathname + '?year=' + year + '&month=' + month + '&day=' + day;
                        if (window.history.replaceState) {
                            window.history.replaceState({}, '', newUrl);
                        }
                    }
                })
                .catch(function() {
                    loadingEl.style.display = 'none';
                    daysEl.style.opacity = '1';
                });
        }

        function tapOnReschedulableEntry(element) {
            if (!currentStudent || !currentBookingCode) return;
            var lessonId = element.dataset.lessonId;
            var dateStr = element.dataset.date, startStr = element.dataset.start, endStr = element.dataset.end;
            if (!lessonId) return;
            clearSelection();
            inlineRescheduleLessonId = parseInt(lessonId, 10);
            inlineRescheduleLessonInfo = dateStr + ' ' + startStr + ' - ' + endStr;
            inlineRescheduleSelectedSlot = null;
            document.querySelectorAll('#public-week-calendar-days .time-slot.reschedule-selected').forEach(function(el) { el.classList.remove('reschedule-selected'); });
            element.classList.add('reschedule-selected');
            document.getElementById('inline-reschedule-banner').style.display = 'block';
            document.getElementById('inline-reschedule-text').textContent = '{% trans "Reschedule: select a new time slot below." %}';
            document.getElementById('inline-reschedule-confirm-btn').style.display = 'none';
        }

        function cancelInlineReschedule() {
            inlineRescheduleLessonId = null;
            inlineRescheduleLessonInfo = null;
            inlineRescheduleSelectedSlot = null;
            document.getElementById('inline-reschedule-banner').style.display = 'none';
            document.querySelectorAll('#public-week-calendar-days .time-slot.reschedule-selected, #public-week-calendar-days .time-slot.selected').forEach(function(el) { el.classList.remove('reschedule-selected', 'selected'); });
            loadWeek(currentYear, currentMonth, currentDay);
        }
        function clearInlineRescheduleState() {
            inlineRescheduleLessonId = null;
            inlineRescheduleLessonInfo = null;
            inlineRescheduleSelectedSlot = null;
            document.getElementById('inline-reschedule-banner').style.display = 'none';
        }

        function confirmInlineReschedule() {
            if (!inlineRescheduleLessonId || !inlineRescheduleSelectedSlot || !currentBookingCode) {
                showMessage('{% trans "Please select a new time slot." %}', 'error');
                return;
            }
            var btn = document.getElementById('inline-reschedule-confirm-btn');
            btn.disabled = true;
            fetch('{% url "lessons:public_booking_reschedule_lesson" %}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                body: JSON.stringify({
                    lesson_id: inlineRescheduleLessonId,
                    new_date: inlineRescheduleSelectedSlot.date,
                    new_start_time: inlineRescheduleSelectedSlot.start,
                    tutor_token: TUTOR_TOKEN,
                    booking_code: currentBookingCode
                })
            })
            .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
            .then(function(result) {
                btn.disabled = false;
                if (result.data.success) {
                    showMessage(result.data.message, 'success');
                    cancelInlineReschedule();
                } else {
                    showMessage(result.data.message || '{% trans "Reschedule failed." %}', 'error');
                }
            })
            .catch(function() {
                btn.disabled = false;
                showMessage('{% trans "Error. Please try again." %}', 'error');
            });
        }

        function renderWeekCalendar(weekData) {
            const occupiedLabel = '{% trans "Occupied" %}';
            const bookedLabel = '{% trans "Booked" %}';
            const tapHint = '{% trans "tap to reschedule" %}';
            const noWorkingHours = '{% trans "No working hours configured for this day." %}';
            let html = '';
            for (const day of weekData.days) {
                const dateFormatted = formatDateLocale(day.date);
                html += '<div class="day-column"><div class="day-header">' + day.weekday_display + ', ' + dateFormatted + '</div>';
                if (day.working_hours && day.working_hours.length > 0) {
                    html += '<div class="time-slots">';
                    for (const slot of day.available_slots) {
                        html += '<div class="time-slot" data-date="' + day.date + '" data-start="' + slot[0] + '" data-end="' + slot[1] + '" onclick="toggleSlot(this)"><div class="time-slot-label">' + slot[0] + '</div></div>';
                    }
                    var intervals = day.busy_intervals || [];
                    if (intervals.length > 0) {
                        for (const bi of intervals) {
                            var label = bi.own && bi.label ? bi.label : bookedLabel;
                            if (bi.own && bi.reschedulable) label += ' (' + tapHint + ')';
                            var cls = bi.own ? 'occupied own-lesson' : 'occupied';
                            if (bi.reschedulable) cls += ' reschedulable';
                            var extra = '';
                            if (bi.reschedulable) {
                                extra = ' data-lesson-id="' + bi.lesson_id + '" data-date="' + day.date + '" data-start="' + bi.start + '" data-end="' + bi.end + '" onclick="tapOnReschedulableEntry(this)"';
                            }
                            html += '<div class="time-slot ' + cls + '"' + extra + '><div class="time-slot-label">' + bi.start + ' - ' + bi.end + '</div><div class="occupied-label">' + escapeHtml(label) + '</div></div>';
                        }
                    } else {
                        for (const occ of day.occupied_slots) {
                            html += '<div class="time-slot occupied"><div class="time-slot-label">' + occ[0] + ' - ' + occ[1] + '</div><div class="occupied-label">' + occupiedLabel + '</div></div>';
                        }
                    }
                    html += '</div>';
                } else {
                    html += '<p style="color: #6c757d;">' + noWorkingHours + '</p>';
                }
                html += '</div>';
            }
            document.getElementById('public-week-calendar-days').innerHTML = html;
        }
        function escapeHtml(s) {
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function formatDateLocale(isoDate) {
            const d = new Date(isoDate + 'T12:00:00');
            const lang = document.documentElement.lang || 'en';
            const locale = lang === 'de' ? 'de-DE' : 'en-US';
            return d.toLocaleDateString(locale);
        }

        function previousWeek() {
            if (inlineRescheduleLessonId) clearInlineRescheduleState();
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() - 7);
            loadWeek(date.getFullYear(), date.getMonth() + 1, date.getDate());
        }

        function nextWeek() {
            if (inlineRescheduleLessonId) clearInlineRescheduleState();
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() + 7);
            loadWeek(date.getFullYear(), date.getMonth() + 1, date.getDate());
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.getAttribute('content')) return meta.getAttribute('content');
            return getCookie('csrftoken');
        }
    </script>
</body>
</html>
