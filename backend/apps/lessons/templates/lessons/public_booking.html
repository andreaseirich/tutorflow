{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Book Lesson" %}</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
            color: #2c3e50; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        h1 { color: #2c3e50; margin-top: 0; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.2s; 
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .message { 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            border-left: 4px solid; 
        }
        .message.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .message.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .step { 
            display: none; 
            margin: 20px 0; 
        }
        .step.active { display: block; }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        .form-group textarea { 
            min-height: 100px; 
        }
        .similar-students { 
            margin: 15px 0; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
        }
        .similar-student { 
            padding: 10px; 
            margin: 5px 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .similar-student:hover { 
            background: #e3f2fd; 
        }
        .time-slots { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 10px; 
            margin: 15px 0; 
        }
        .time-slot { 
            padding: 10px; 
            border: 2px solid #007bff; 
            border-radius: 4px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: white; 
        }
        .time-slot:hover { 
            background: #e3f2fd; 
            transform: scale(1.05); 
        }
        .time-slot.occupied { 
            background: #f8d7da; 
            border-color: #dc3545; 
            cursor: not-allowed; 
            opacity: 0.6; 
        }
        .time-slot.selected { 
            background: #fff3cd; 
            border-color: #ffc107; 
            border-width: 3px; 
        }
        .day-column { 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px; 
            background: white; 
        }
        .day-header { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin-bottom: 15px; 
            color: #2c3e50; 
        }
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            padding: 0;
        }
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 0 5px;
        }
        .progress-step.active {
            background: #007bff;
            color: white;
        }
        .progress-step.completed {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{% trans "Book Lesson" %}</h1>
        
        <div id="messages"></div>
        
        <div class="progress-indicator">
            <div class="progress-step active" id="step-indicator-1">1. {% trans "Name" %}</div>
            <div class="progress-step" id="step-indicator-2">2. {% trans "Data" %}</div>
            <div class="progress-step" id="step-indicator-3">3. {% trans "Time Slot" %}</div>
            <div class="progress-step" id="step-indicator-4">4. {% trans "Confirm" %}</div>
        </div>
        
        <!-- Schritt 1: Name eingeben -->
        <div class="step active" id="step-1">
            <h2>{% trans "Enter your name" %}</h2>
            <div class="form-group">
                <label for="student-name">{% trans "Full Name" %}</label>
                <input type="text" id="student-name" placeholder="{% trans 'e.g., Max Mustermann' %}" required>
            </div>
            <button class="btn" onclick="searchStudent()">{% trans "Continue" %}</button>
        </div>
        
        <!-- Schritt 2a: Neuer Schüler -->
        <div class="step" id="step-2a">
            <h2>{% trans "Create New Student" %}</h2>
            <form id="new-student-form">
                <div class="form-group">
                    <label for="first-name">{% trans "First Name" %} *</label>
                    <input type="text" id="first-name" required>
                </div>
                <div class="form-group">
                    <label for="last-name">{% trans "Last Name" %} *</label>
                    <input type="text" id="last-name" required>
                </div>
                <div class="form-group">
                    <label for="email">{% trans "Email" %}</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="phone">{% trans "Phone" %}</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="school">{% trans "School" %}</label>
                    <input type="text" id="school">
                </div>
                <div class="form-group">
                    <label for="grade">{% trans "Grade" %}</label>
                    <input type="text" id="grade">
                </div>
                <div class="form-group">
                    <label for="subjects">{% trans "Subjects" %}</label>
                    <input type="text" id="subjects" placeholder="{% trans 'e.g., Math, German' %}">
                </div>
                <div class="form-group">
                    <label for="institute">{% trans "Institute" %}</label>
                    <input type="text" id="institute">
                    <small>{% trans "Leave empty if no institute" %}</small>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">{% trans "Back" %}</button>
                <button type="button" class="btn btn-success" onclick="createStudent()">{% trans "Continue" %}</button>
            </form>
        </div>
        
        <!-- Schritt 2b: Bestehender Schüler - Buchungsformular -->
        <div class="step" id="step-2b">
            <h2>{% trans "Book Lesson" %} - <span id="student-name-display"></span></h2>
            <form id="booking-form">
                <div class="form-group">
                    <label for="subject">{% trans "Subject" %}</label>
                    <input type="text" id="subject" placeholder="{% trans 'e.g., Math' %}">
                </div>
                <div class="form-group">
                    <label for="booking-notes">{% trans "Notes" %}</label>
                    <textarea id="booking-notes" placeholder="{% trans 'Additional notes for the lesson...' %}"></textarea>
                </div>
                <div class="form-group">
                    <label for="documents">{% trans "Upload Documents" %}</label>
                    <input type="file" id="documents" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
                    <small>{% trans "You can upload multiple files (PDF, DOC, DOCX, TXT, JPG, PNG, max 10 MB each)" %}</small>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">{% trans "Back" %}</button>
                <button type="button" class="btn btn-success" onclick="goToStep(3)">{% trans "Continue" %}</button>
            </form>
        </div>
        
        <!-- Schritt 3: Zeitslot-Auswahl -->
        <div class="step" id="step-3">
            <h2>{% trans "Select Time Slot" %}</h2>
            <div class="btn-group">
                <button class="btn" onclick="previousWeek()">← {% trans "Previous Week" %}</button>
                <button class="btn" onclick="nextWeek()">{% trans "Next Week" %} →</button>
            </div>
            <div id="selected-slots-info" style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 4px; display: none;">
                <strong>{% trans "Selected:" %}</strong> <span id="selected-range"></span>
                <button class="btn btn-secondary" onclick="clearSelection()" style="margin-left: 10px;">{% trans "Clear Selection" %}</button>
            </div>
            
            <div class="week-calendar">
                {% for day in week_data.days %}
                <div class="day-column">
                    <div class="day-header">
                        {{ day.weekday_display }}, {{ day.date|date:"d.m.Y" }}
                    </div>
                    
                    {% if day.working_hours %}
                        <div class="time-slots">
                            {% for slot in day.available_slots %}
                            <div class="time-slot" 
                                 data-date="{{ day.date|date:'Y-m-d' }}" 
                                 data-start="{{ slot.0|time:'H:i' }}" 
                                 data-end="{{ slot.1|time:'H:i' }}"
                                 onclick="toggleSlot(this)">
                                <div class="time-slot-label">
                                    {{ slot.0|time:'H:i' }}
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% for occupied in day.occupied_slots %}
                            <div class="time-slot occupied">
                                <div class="time-slot-label">
                                    {{ occupied.0|time:'H:i' }} - {{ occupied.1|time:'H:i' }}
                                </div>
                                <div class="occupied-label">{% trans "Occupied" %}</div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p style="color: #6c757d;">{% trans "No working hours configured for this day." %}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="goToStep(2)">{% trans "Back" %}</button>
            <button type="button" class="btn btn-success" onclick="goToStep(4)" id="continue-to-confirm" disabled>{% trans "Continue to Confirm" %}</button>
        </div>
        
        <!-- Schritt 4: Bestätigung -->
        <div class="step" id="step-4">
            <h2>{% trans "Confirm Booking" %}</h2>
            <div id="booking-summary"></div>
            <button type="button" class="btn btn-secondary" onclick="goToStep(3)">{% trans "Back" %}</button>
            <button type="button" class="btn btn-success" onclick="confirmBooking()">{% trans "Confirm and Book" %}</button>
        </div>
    </div>
    
    <script>
        const currentYear = {{ current_date.year }};
        const currentMonth = {{ current_date.month }};
        const currentDay = {{ current_date.day }};
        
        let currentStudent = null;
        let selectedSlots = [];
        let currentDate = null;
        let bookingData = {};
        
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }
        
        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            
            // Show selected step
            if (stepNumber === 2) {
                // Decide between 2a and 2b
                if (currentStudent) {
                    document.getElementById('step-2b').classList.add('active');
                } else {
                    document.getElementById('step-2a').classList.add('active');
                }
            } else {
                document.getElementById(`step-${stepNumber}`).classList.add('active');
            }
            
            // Update Progress Indicator
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // Special logic for Step 4
            if (stepNumber === 4) {
                updateBookingSummary();
            }
            
            // Special logic for Step 3
            if (stepNumber === 3) {
                updateContinueButton();
            }
        }
        
        function searchStudent() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) {
                showMessage('{% trans "Please enter your name." %}', 'error');
                return;
            }
            
            // Use centralized API helper if available, otherwise use fetch with proper error handling
            if (typeof apiRequest === 'function') {
                apiRequest('{% url "lessons:public_booking_search_student" %}', {
                    method: 'POST',
                    body: JSON.stringify({ name: name })
                })
                .then(data => {
                    if (data.success) {
                        if (data.exact_match) {
                            // Exact match found
                            currentStudent = data.student;
                            document.getElementById('student-name-display').textContent = data.student.full_name;
                            goToStep(2);
                        } else if (data.similar_students && data.similar_students.length > 0) {
                            // Similar names found
                            showSimilarStudents(data.similar_students, name);
                        } else {
                            // No match found
                            goToStep(2);
                        }
                    } else {
                        showMessage(data.message || '{% trans "Error searching for student." %}', 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error searching for student. Please try again." %}', 'error');
                });
            } else {
                // Fallback to fetch with improved error handling
                fetch('{% url "lessons:public_booking_search_student" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ name: name })
                })
                .then(async response => {
                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            errorMessage = response.statusText || '{% trans "Server error" %}';
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (data.exact_match) {
                            currentStudent = data.student;
                            document.getElementById('student-name-display').textContent = data.student.full_name;
                            goToStep(2);
                        } else if (data.similar_students && data.similar_students.length > 0) {
                            showSimilarStudents(data.similar_students, name);
                        } else {
                            goToStep(2);
                        }
                    } else {
                        showMessage(data.message || '{% trans "Error searching for student." %}', 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error searching for student. Please try again." %}', 'error');
                });
            }
        }
        
        function showSimilarStudents(similarStudents, searchedName) {
            const step1 = document.getElementById('step-1');
            let html = '<div class="similar-students">';
            html += '<h3>{% trans "Similar names found" %}</h3>';
            html += '<p>{% trans "Did you mean one of these?" %}</p>';
            similarStudents.forEach(student => {
                html += `<div class="similar-student" onclick="selectStudent(${student.id}, '${student.full_name}')">`;
                html += `<strong>${student.full_name}</strong> (${student.similarity}% {% trans "similar" %})`;
                html += '</div>';
            });
            html += '<div class="similar-student" onclick="goToStep(2)" style="border: 2px dashed #007bff;">';
            html += '<strong>{% trans "Create new student" %}: ' + searchedName + '</strong>';
            html += '</div>';
            html += '</div>';
            step1.insertAdjacentHTML('beforeend', html);
        }
        
        function selectStudent(studentId, studentName) {
            const url = '{% url "lessons:public_booking_search_student" %}';
            const options = {
                method: 'POST',
                body: JSON.stringify({ name: studentName })
            };
            
            if (typeof apiRequest === 'function') {
                apiRequest(url, options)
                .then(data => {
                    if (data.success && data.exact_match) {
                        currentStudent = data.student;
                        document.getElementById('student-name-display').textContent = data.student.full_name;
                        goToStep(2);
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error selecting student." %}', 'error');
                });
            } else {
                fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(async response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.exact_match) {
                        currentStudent = data.student;
                        document.getElementById('student-name-display').textContent = data.student.full_name;
                        goToStep(2);
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error selecting student." %}', 'error');
                });
            }
        }
        
        function createStudent() {
            const formData = {
                first_name: document.getElementById('first-name').value.trim(),
                last_name: document.getElementById('last-name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                school: document.getElementById('school').value.trim(),
                grade: document.getElementById('grade').value.trim(),
                subjects: document.getElementById('subjects').value.trim(),
                institute: document.getElementById('institute').value.trim()
            };
            
            if (!formData.first_name || !formData.last_name) {
                showMessage('{% trans "First name and last name are required." %}', 'error');
                return;
            }
            
            const url = '{% url "lessons:public_booking_create_student" %}';
            const options = {
                method: 'POST',
                body: JSON.stringify(formData)
            };
            
            if (typeof apiRequest === 'function') {
                apiRequest(url, options)
                .then(data => {
                    if (data.success) {
                        currentStudent = data.student;
                        document.getElementById('student-name-display').textContent = data.student.full_name;
                        goToStep(2);
                    } else {
                        showMessage(data.message || '{% trans "Error creating student." %}', 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error creating student. Please try again." %}', 'error');
                });
            } else {
                fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(async response => {
                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            errorMessage = response.statusText || '{% trans "Server error" %}';
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentStudent = data.student;
                        document.getElementById('student-name-display').textContent = data.student.full_name;
                        goToStep(2);
                    } else {
                        showMessage(data.message || '{% trans "Error creating student." %}', 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error creating student. Please try again." %}', 'error');
                });
            }
        }
        
        function toggleSlot(element) {
            if (element.classList.contains('occupied')) {
                return;
            }
            
            const date = element.dataset.date;
            const startTime = element.dataset.start;
            const endTime = element.dataset.end;
            
            if (currentDate && currentDate !== date) {
                clearSelection();
            }
            currentDate = date;
            
            const slotKey = `${date}_${startTime}`;
            const slotIndex = selectedSlots.findIndex(s => s.key === slotKey);
            
            if (slotIndex >= 0) {
                selectedSlots.splice(slotIndex, 1);
                element.classList.remove('selected');
            } else {
                if (selectedSlots.length > 0) {
                    const sortedSlots = [...selectedSlots, { key: slotKey, date, startTime, endTime }]
                        .sort((a, b) => {
                            if (a.date !== b.date) return a.date.localeCompare(b.date);
                            return a.startTime.localeCompare(b.startTime);
                        });
                    
                    let isConsecutive = true;
                    for (let i = 1; i < sortedSlots.length; i++) {
                        const prevEnd = sortedSlots[i - 1].endTime;
                        const currStart = sortedSlots[i].startTime;
                        if (prevEnd !== currStart) {
                            isConsecutive = false;
                            break;
                        }
                    }
                    
                    if (!isConsecutive) {
                        showMessage('{% trans "Please select consecutive time slots only." %}', 'error');
                        return;
                    }
                }
                
                selectedSlots.push({ key: slotKey, date, startTime, endTime });
                element.classList.add('selected');
            }
            
            updateSelectionInfo();
            updateContinueButton();
        }
        
        function updateSelectionInfo() {
            const infoDiv = document.getElementById('selected-slots-info');
            const rangeSpan = document.getElementById('selected-range');
            
            if (selectedSlots.length === 0) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            rangeSpan.textContent = `${firstSlot.date} ${firstSlot.startTime} - ${lastSlot.date} ${lastSlot.endTime}`;
            infoDiv.style.display = 'block';
        }
        
        function clearSelection() {
            selectedSlots.forEach(slot => {
                const element = document.querySelector(`[data-date="${slot.date}"][data-start="${slot.startTime}"]`);
                if (element) {
                    element.classList.remove('selected');
                }
            });
            selectedSlots = [];
            currentDate = null;
            updateSelectionInfo();
            updateContinueButton();
        }
        
        function updateContinueButton() {
            const btn = document.getElementById('continue-to-confirm');
            if (selectedSlots.length > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        function updateBookingSummary() {
            const summaryDiv = document.getElementById('booking-summary');
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            bookingData = {
                student_id: currentStudent.id,
                date: firstSlot.date,
                start_time: firstSlot.startTime,
                end_time: lastSlot.endTime,
                subject: document.getElementById('subject').value.trim(),
                notes: document.getElementById('booking-notes').value.trim(),
                institute: document.getElementById('institute') ? document.getElementById('institute').value.trim() : ''
            };
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 4px;">';
            html += `<p><strong>{% trans "Student" %}:</strong> ${currentStudent.full_name}</p>`;
            html += `<p><strong>{% trans "Date" %}:</strong> ${firstSlot.date}</p>`;
            html += `<p><strong>{% trans "Time" %}:</strong> ${firstSlot.startTime} - ${lastSlot.endTime}</p>`;
            if (bookingData.subject) {
                html += `<p><strong>{% trans "Subject" %}:</strong> ${bookingData.subject}</p>`;
            }
            if (bookingData.notes) {
                html += `<p><strong>{% trans "Notes" %}:</strong> ${bookingData.notes}</p>`;
            }
            const files = document.getElementById('documents').files;
            if (files.length > 0) {
                html += `<p><strong>{% trans "Documents" %}:</strong> ${files.length} {% trans "file(s)" %}</p>`;
            }
            html += '</div>';
            
            summaryDiv.innerHTML = html;
        }
        
        function confirmBooking() {
            if (!currentStudent || selectedSlots.length === 0) {
                showMessage('{% trans "Please complete all steps." %}', 'error');
                return;
            }
            
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            if (firstSlot.date !== lastSlot.date) {
                showMessage('{% trans "All selected slots must be on the same day." %}', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', currentStudent.id);
            formData.append('date', firstSlot.date);
            formData.append('start_time', firstSlot.startTime);
            formData.append('end_time', lastSlot.endTime);
            formData.append('subject', document.getElementById('subject').value.trim());
            formData.append('notes', document.getElementById('booking-notes').value.trim());
            const instituteInput = document.getElementById('institute');
            if (instituteInput) {
                formData.append('institute', instituteInput.value.trim());
            }
            
            const files = document.getElementById('documents').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            const url = '{% url "lessons:public_booking_book_lesson" %}';
            const options = {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            };
            
            // Note: apiRequest helper doesn't work with FormData, so use fetch directly with improved error handling
            fetch(url, options)
            .then(async response => {
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = response.statusText || '{% trans "Server error" %}';
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(() => {
                        // Reset and return to step 1
                        currentStudent = null;
                        selectedSlots = [];
                        document.getElementById('student-name').value = '';
                        document.getElementById('new-student-form').reset();
                        document.getElementById('booking-form').reset();
                        clearSelection();
                        goToStep(1);
                    }, 2000);
                } else {
                    showMessage(data.message || '{% trans "Error booking lesson." %}', 'error');
                }
            })
            .catch(error => {
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showMessage('{% trans "Network error: Please check your internet connection." %}', 'error');
                } else {
                    showMessage(error.message || '{% trans "Error booking lesson. Please try again." %}', 'error');
                }
            });
        }
        
        function previousWeek() {
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() - 7);
            window.location.href = `?year=${date.getFullYear()}&month=${date.getMonth() + 1}&day=${date.getDate()}`;
        }
        
        function nextWeek() {
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() + 7);
            window.location.href = `?year=${date.getFullYear()}&month=${date.getMonth() + 1}&day=${date.getDate()}`;
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
