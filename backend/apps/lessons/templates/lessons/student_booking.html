{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'de' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Book Lesson" %} - {{ student.full_name }}</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
            color: #2c3e50; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        h1 { color: #2c3e50; margin-top: 0; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.2s; 
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-group { margin: 20px 0; }
        .btn-group .btn { margin-right: 10px; }
        .message { 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            border-left: 4px solid; 
        }
        .message.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .message.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .working-hours-config { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 4px; 
            margin-bottom: 30px; 
        }
        .day-config { 
            margin-bottom: 15px; 
            padding: 15px; 
            background: white; 
            border-radius: 4px; 
            border: 1px solid #ddd; 
        }
        .day-config h3 { margin-top: 0; color: #34495e; }
        .time-range { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .time-range input[type="time"] { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .time-range button { 
            padding: 8px 15px; 
            background: #dc3545; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .add-time-range { 
            margin-top: 10px; 
            padding: 8px 15px; 
            background: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .week-calendar { 
            margin-top: 30px; 
        }
        .day-column { 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px; 
            background: white; 
        }
        .day-header { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin-bottom: 15px; 
            color: #2c3e50; 
        }
        .time-slots { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
        }
        .time-slot { 
            padding: 10px; 
            border: 2px solid #007bff; 
            border-radius: 4px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: white; 
        }
        .time-slot:hover { 
            background: #e3f2fd; 
            transform: scale(1.05); 
        }
        .time-slot.occupied { 
            background: #f8d7da; 
            border-color: #dc3545; 
            cursor: not-allowed; 
            opacity: 0.6; 
        }
        .time-slot.occupied:hover { 
            background: #f8d7da; 
            transform: none; 
        }
        .time-slot.own-lesson { 
            background: #d4edda; 
            border-color: #28a745; 
        }
        .time-slot.booked { 
            background: #d4edda; 
            border-color: #28a745; 
        }
        .time-slot.selected { 
            background: #fff3cd; 
            border-color: #ffc107; 
            border-width: 3px; 
        }
        .time-slot.selected:hover { 
            background: #ffe69c; 
        }
        .time-slot-label { 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .occupied-label { 
            color: #dc3545; 
            font-size: 0.9em; 
        }
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #6c757d; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{% trans "Book Lesson" %} - {{ student.full_name }}</h1>
        
        <div id="messages"></div>
        
        <div class="btn-group">
            <button class="btn" onclick="previousWeek()">← {% trans "Previous Week" %}</button>
            <button class="btn" onclick="nextWeek()">{% trans "Next Week" %} →</button>
            <label style="margin-left: 15px; display: inline-flex; align-items: center; gap: 8px;">
                {% trans "Jump to date:" %}
                <input type="date" id="jump-to-date" value="{{ current_date|date:'Y-m-d' }}" 
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       onchange="jumpToDate(this.value)">
            </label>
            <button class="btn btn-secondary" onclick="showRecurringBookingModal()">{% trans "Book Recurring Lesson" %}</button>
        </div>
        
        <!-- Modal für Serientermin-Buchung -->
        <div id="recurring-booking-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                <h2>{% trans "Book Recurring Lesson" %}</h2>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>{% trans "Start Date:" %}</strong></label>
                    <input type="date" id="recurring-start-date" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>{% trans "Start Time:" %}</strong></label>
                    <input type="time" id="recurring-start-time" required step="1800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>{% trans "End Time:" %}</strong></label>
                    <input type="time" id="recurring-end-time" required step="1800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>{% trans "Recurrence Type:" %}</strong></label>
                    <select id="recurring-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="weekly">{% trans "Weekly" %}</option>
                        <option value="biweekly">{% trans "Bi-weekly" %}</option>
                        <option value="monthly">{% trans "Monthly" %}</option>
                    </select>
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;"><strong>{% trans "Weekdays:" %}</strong></label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label><input type="checkbox" value="0" class="weekday-checkbox"> {% trans "Monday" %}</label>
                        <label><input type="checkbox" value="1" class="weekday-checkbox"> {% trans "Tuesday" %}</label>
                        <label><input type="checkbox" value="2" class="weekday-checkbox"> {% trans "Wednesday" %}</label>
                        <label><input type="checkbox" value="3" class="weekday-checkbox"> {% trans "Thursday" %}</label>
                        <label><input type="checkbox" value="4" class="weekday-checkbox"> {% trans "Friday" %}</label>
                        <label><input type="checkbox" value="5" class="weekday-checkbox"> {% trans "Saturday" %}</label>
                        <label><input type="checkbox" value="6" class="weekday-checkbox"> {% trans "Sunday" %}</label>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>{% trans "End Date (optional):" %}</strong></label>
                    <input type="date" id="recurring-end-date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeRecurringBookingModal()">{% trans "Cancel" %}</button>
                    <button class="btn btn-success" onclick="confirmRecurringBooking()">{% trans "Book Recurring Lesson" %}</button>
                </div>
            </div>
        </div>
        
        <div class="week-calendar">
            <h2>{% trans "Available Time Slots" %}</h2>
            <p>{% trans "Click on a time slot to select one lesson block (duration from your contract)." %}</p>
            <div id="selected-slots-info" style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 4px; display: none;">
                <strong>{% trans "Selected:" %}</strong> <span id="selected-range"></span>
                <button class="btn btn-success" onclick="confirmBooking()" style="margin-left: 15px;">{% trans "Book Selected Slots" %}</button>
                <button class="btn btn-secondary" onclick="clearSelection()" style="margin-left: 10px;">{% trans "Clear Selection" %}</button>
            </div>
            <div id="week-calendar-loading" style="display: none;" class="loading">{% trans "Loading..." %}</div>
            <div id="week-calendar-days">
            {% for day in week_data.days %}
            <div class="day-column">
                <div class="day-header">
                    {{ day.weekday_display }}, {{ day.date|date:"d.m.Y" }}
                </div>
                
                {% if day.working_hours %}
                    <div class="time-slots">
                        {% for slot in day.available_slots %}
                        <div class="time-slot" 
                             data-date="{{ day.date|date:'Y-m-d' }}" 
                             data-start="{{ slot.0|time:'H:i' }}" 
                             data-end="{{ slot.1|time:'H:i' }}"
                             onclick="toggleSlot(this)">
                            <div class="time-slot-label">
                                {{ slot.0|time:'H:i' }}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if day.busy_intervals %}
                        {% for bi in day.busy_intervals %}
                        <div class="time-slot occupied {% if bi.own %}own-lesson{% endif %}">
                            <div class="time-slot-label">{{ bi.start }} - {{ bi.end }}</div>
                            <div class="occupied-label">{% if bi.own %}{{ bi.label }}{% else %}{% trans "Booked" %}{% endif %}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        {% for occupied in day.occupied_slots %}
                        <div class="time-slot occupied">
                            <div class="time-slot-label">
                                {{ occupied.0|time:'H:i' }} - {{ occupied.1|time:'H:i' }}
                            </div>
                            <div class="occupied-label">{% trans "Occupied" %}</div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                {% else %}
                    <p style="color: #6c757d;">{% trans "No working hours configured for this day." %}</p>
                {% endif %}
            </div>
            {% endfor %}
            </div>
        </div>
    </div>
    
    <script>
        const token = '{{ contract.booking_token }}';
        const currentYear = {{ current_date.year }};
        const currentMonth = {{ current_date.month }};
        const currentDay = {{ current_date.day }};
        const contractDuration = {{ contract.unit_duration_minutes }};
        
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }
        
        let selectedSlots = [];
        let currentDate = null;
        
        function toggleSlot(element) {
            if (element.classList.contains('occupied') || element.classList.contains('booked')) return;
            var date = element.dataset.date, startTime = element.dataset.start, endTime = element.dataset.end;
            var slotKey = date + '_' + startTime;
            if (selectedSlots.length === 1 && selectedSlots[0].key === slotKey) {
                clearSelection();
                return;
            }
            clearSelection();
            selectedSlots = [{ key: slotKey, date: date, startTime: startTime, endTime: endTime }];
            element.classList.add('selected');
            currentDate = date;
            updateSelectionInfo();
        }
        
        function updateSelectionInfo() {
            var infoDiv = document.getElementById('selected-slots-info'), rangeSpan = document.getElementById('selected-range');
            if (selectedSlots.length === 0) { infoDiv.style.display = 'none'; return; }
            var s = selectedSlots[0];
            rangeSpan.textContent = s.date + ' ' + s.startTime + ' - ' + s.endTime;
            infoDiv.style.display = 'block';
        }
        
        function clearSelection() {
            selectedSlots.forEach(slot => {
                const element = document.querySelector(`[data-date="${slot.date}"][data-start="${slot.startTime}"]`);
                if (element) {
                    element.classList.remove('selected');
                }
            });
            selectedSlots = [];
            currentDate = null;
            updateSelectionInfo();
        }
        
        function confirmBooking() {
            if (selectedSlots.length === 0) {
                showMessage('{% trans "Please select at least one time slot." %}', 'error');
                return;
            }
            
            // Sortiere Slots nach Zeit
            const sortedSlots = [...selectedSlots].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.startTime.localeCompare(b.startTime);
            });
            
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            
            // Check if all slots are on the same day
            if (firstSlot.date !== lastSlot.date) {
                showMessage('{% trans "All selected slots must be on the same day." %}', 'error');
                return;
            }
            
            const startTime = firstSlot.startTime;
            const endTime = lastSlot.endTime;
            const date = firstSlot.date;
            
            if (!confirm(`{% trans "Book lesson on" %} ${date} {% trans "from" %} ${startTime} {% trans "to" %} ${endTime}?`)) {
                return;
            }
            
            const url = `/lessons/booking/${token}/api/`;
            const options = {
                method: 'POST',
                body: JSON.stringify({
                    action: 'book_slot',
                    date: date,
                    start_time: startTime,
                    end_time: endTime
                })
            };
            
            if (typeof apiRequest === 'function') {
                apiRequest(url, options)
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        // Mark all selected slots as booked
                        selectedSlots.forEach(slot => {
                            const element = document.querySelector(`[data-date="${slot.date}"][data-start="${slot.startTime}"]`);
                            if (element) {
                                element.classList.remove('selected');
                                element.classList.add('booked');
                                element.onclick = null;
                            }
                        });
                        clearSelection();
                        // Reload page after short delay
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error booking lesson. Please try again." %}', 'error');
                });
            } else {
                fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(async response => {
                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            errorMessage = response.statusText || '{% trans "Server error" %}';
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        selectedSlots.forEach(slot => {
                            const element = document.querySelector(`[data-date="${slot.date}"][data-start="${slot.startTime}"]`);
                            if (element) {
                                element.classList.remove('selected');
                                element.classList.add('booked');
                                element.onclick = null;
                            }
                        });
                        clearSelection();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        showMessage('{% trans "Network error: Please check your internet connection." %}', 'error');
                    } else {
                        showMessage(error.message || '{% trans "Error booking lesson. Please try again." %}', 'error');
                    }
                });
            }
        }
        
        function loadWeek(year, month, day) {
            const loadingEl = document.getElementById('week-calendar-loading');
            const daysEl = document.getElementById('week-calendar-days');
            loadingEl.style.display = 'block';
            daysEl.style.opacity = '0.5';
            
            const url = '/lessons/booking/' + encodeURIComponent(token) + '/week/?year=' + year + '&month=' + month + '&day=' + day;
            fetch(url)
                .then(function(response) {
                    return response.json().then(function(data) {
                        return { ok: response.ok, data: data };
                    });
                })
                .then(function(result) {
                    loadingEl.style.display = 'none';
                    daysEl.style.opacity = '1';
                    if (result.ok && result.data && result.data.success && result.data.week_data) {
                        var messagesEl = document.getElementById('messages');
                        if (messagesEl) messagesEl.innerHTML = '';
                        renderWeekCalendar(result.data.week_data);
                        currentYear = year;
                        currentMonth = month;
                        currentDay = day;
                        clearSelection();
                        var jumpInput = document.getElementById('jump-to-date');
                        if (jumpInput) {
                            jumpInput.value = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        }
                        var newUrl = window.location.pathname + '?year=' + year + '&month=' + month + '&day=' + day;
                        if (window.history.replaceState) {
                            window.history.replaceState({}, '', newUrl);
                        }
                    }
                })
                .catch(function() {
                    loadingEl.style.display = 'none';
                    daysEl.style.opacity = '1';
                });
        }
        
        function renderWeekCalendar(weekData) {
            const occupiedLabel = '{% trans "Occupied" %}';
            const bookedLabel = '{% trans "Booked" %}';
            const noWorkingHours = '{% trans "No working hours configured for this day." %}';
            const escapeHtml = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
            
            let html = '';
            for (const day of weekData.days) {
                const dateFormatted = formatDateLocale(day.date);
                html += `<div class="day-column">
                    <div class="day-header">${day.weekday_display}, ${dateFormatted}</div>`;
                if (day.working_hours && day.working_hours.length > 0) {
                    html += '<div class="time-slots">';
                    for (const slot of day.available_slots) {
                        html += `<div class="time-slot" data-date="${day.date}" data-start="${slot[0]}" data-end="${slot[1]}" onclick="toggleSlot(this)">
                            <div class="time-slot-label">${slot[0]}</div></div>`;
                    }
                    var intervals = day.busy_intervals || [];
                    if (intervals.length > 0) {
                        for (const bi of intervals) {
                            var label = bi.own && bi.label ? bi.label : bookedLabel;
                            var cls = bi.own ? 'occupied own-lesson' : 'occupied';
                            html += `<div class="time-slot ${cls}"><div class="time-slot-label">${bi.start} - ${bi.end}</div>
                                <div class="occupied-label">${escapeHtml(label)}</div></div>`;
                        }
                    } else {
                        for (const occ of day.occupied_slots) {
                            html += `<div class="time-slot occupied"><div class="time-slot-label">${occ[0]} - ${occ[1]}</div>
                                <div class="occupied-label">${occupiedLabel}</div></div>`;
                        }
                    }
                    html += '</div>';
                } else {
                    html += `<p style="color: #6c757d;">${noWorkingHours}</p>`;
                }
                html += '</div>';
            }
            document.getElementById('week-calendar-days').innerHTML = html;
        }
        
        function formatDateLocale(isoDate) {
            const d = new Date(isoDate + 'T12:00:00');
            const lang = document.documentElement.lang || 'en';
            const locale = lang === 'de' ? 'de-DE' : 'en-US';
            return d.toLocaleDateString(locale);
        }
        
        function previousWeek() {
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() - 7);
            loadWeek(date.getFullYear(), date.getMonth() + 1, date.getDate());
        }
        
        function nextWeek() {
            const date = new Date(currentYear, currentMonth - 1, currentDay);
            date.setDate(date.getDate() + 7);
            loadWeek(date.getFullYear(), date.getMonth() + 1, date.getDate());
        }
        
        function jumpToDate(dateStr) {
            if (!dateStr) return;
            const d = new Date(dateStr + 'T12:00:00');
            loadWeek(d.getFullYear(), d.getMonth() + 1, d.getDate());
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showRecurringBookingModal() {
            document.getElementById('recurring-booking-modal').style.display = 'block';
            // Setze Standard-Startdatum auf heute
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('recurring-start-date').value = dateStr;
        }
        
        function closeRecurringBookingModal() {
            document.getElementById('recurring-booking-modal').style.display = 'none';
        }
        
        function confirmRecurringBooking() {
            const startDate = document.getElementById('recurring-start-date').value;
            const startTime = document.getElementById('recurring-start-time').value;
            const endTime = document.getElementById('recurring-end-time').value;
            const recurrenceType = document.getElementById('recurring-type').value;
            const endDate = document.getElementById('recurring-end-date').value || null;
            
            // Collect selected weekdays
            const weekdays = [];
            document.querySelectorAll('.weekday-checkbox:checked').forEach(checkbox => {
                weekdays.push(parseInt(checkbox.value));
            });
            
            if (!startDate || !startTime || !endTime) {
                showMessage('{% trans "Please fill in all required fields." %}', 'error');
                return;
            }
            
            if (weekdays.length === 0) {
                showMessage('{% trans "Please select at least one weekday." %}', 'error');
                return;
            }
            
            const requestData = {
                action: 'book_recurring_slot',
                date: startDate,
                start_time: startTime,
                end_time: endTime,
                recurrence_type: recurrenceType,
                weekdays: weekdays
            };
            
            if (endDate) {
                requestData.end_date = endDate;
            }
            
            const url = `/lessons/booking/${token}/api/`;
            const options = {
                method: 'POST',
                body: JSON.stringify(requestData)
            };
            
            if (typeof apiRequest === 'function') {
                apiRequest(url, options)
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        closeRecurringBookingModal();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage(error.message || '{% trans "Error booking recurring lesson. Please try again." %}', 'error');
                });
            } else {
                fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(async response => {
                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            errorMessage = response.statusText || '{% trans "Server error" %}';
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        closeRecurringBookingModal();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        showMessage('{% trans "Network error: Please check your internet connection." %}', 'error');
                    } else {
                        showMessage(error.message || '{% trans "Error booking recurring lesson. Please try again." %}', 'error');
                    }
                });
            }
        }
    </script>
</body>
</html>
