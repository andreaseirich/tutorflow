{% extends 'core/base.html' %}
{% load i18n %}
{% load lesson_filters %}

{% block title %}{% trans "Week View" %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Week View" %}</h1>

<div class="btn-group">
    <a href="{% url 'lessons:week' %}?year={{ prev_week.year }}&month={{ prev_week.month }}&day={{ prev_week.day }}" class="btn">‚Üê {% trans "Previous Week" %}</a>
    <a href="{% url 'lessons:week' %}?year={{ next_week.year }}&month={{ next_week.month }}&day={{ next_week.day }}" class="btn">{% trans "Next Week" %} ‚Üí</a>
</div>

<p style="margin-top: 10px; color: #495057; font-size: 0.9em;">
    <strong>{% trans "Note:" %}</strong> {% trans "Drag a time range in the calendar to create a new appointment. Click on an existing appointment to edit it." %}
</p>

<div id="week-calendar" style="margin-top: 20px; position: relative; overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr>
                <th style="width: 80px; border: 1px solid #ddd; padding: 8px; background: #f5f5f5; text-align: center;">{% trans "Time" %}</th>
                {% for weekday in weekdays %}
                <th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5; text-align: center; {% if weekday.date == today %}background: #e3f2fd;{% endif %}">
                    {{ weekday.name_short }}<br>
                    <small style="font-weight: normal;">{{ weekday.date.day }}.{{ weekday.date.month }}.</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
            <tr data-hour="{{ hour }}" style="height: 60px;">
                <td style="border: 1px solid #ddd; padding: 4px; text-align: center; background: #f9f9f9; font-size: 0.85em;">
                    {{ hour }}:00
                </td>
                {% for weekday in weekdays %}
                <td class="time-slot" 
                    data-date="{{ weekday.date|date:'Y-m-d' }}" 
                    data-hour="{{ hour }}"
                    style="border: 1px solid #ddd; padding: 0; position: relative; vertical-align: top; cursor: crosshair;"
                    onmousedown="startDrag(event, this)"
                    onmousemove="handleDrag(event, this)"
                    onmouseup="endDrag(event, this)"
                    onmouseleave="cancelDrag(event)">
                    <div class="slot-content" style="position: relative; height: 100%; width: 100%;">
                        {% for lesson in weekday.lessons %}
                            {% if lesson.start_time.hour|add:0 == hour|add:0 %}
                            <div class="lesson-block {% if lesson.id in conflicts_by_lesson %}has-conflict{% endif %}" 
                                 data-lesson-id="{{ lesson.id }}"
                                 data-start-hour="{{ lesson.start_time.hour }}"
                                 data-start-minute="{{ lesson.start_time.minute }}"
                                 data-duration="{{ lesson.duration_minutes }}"
                                 style="position: absolute; 
                                        top: {{ lesson.start_time.minute }}px; 
                                        height: {{ lesson.duration_minutes }}px; 
                                        left: 0; 
                                        right: 0; 
                                        background: #2196f3; 
                                        color: white; 
                                        padding: 2px 4px; 
                                        font-size: 0.75em; 
                                        border-radius: 3px;
                                        cursor: pointer;
                                        z-index: 10;
                                        overflow: hidden;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                        transition: all 0.2s;
                                        {% if lesson.id in conflicts_by_lesson %}border: 2px solid #dc3545;{% endif %}"
                                 onmouseover="showLessonPreview(this, event); this.style.background='#1976d2'; this.style.transform='scale(1.02)'; this.style.zIndex='20';"
                                 onmouseout="hideLessonPreview(); this.style.background='#2196f3'; this.style.transform='scale(1)'; this.style.zIndex='10';"
                                 onclick="event.stopPropagation(); window.location.href='{% url 'lesson_plans:lesson_plan' lesson.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}'"
                                 title="{{ lesson.contract.student.full_name }} - {{ lesson.start_time|time:'H:i' }} ({{ lesson.duration_minutes }} Min.) - {% trans 'Click to view lesson plan' %}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <span style="font-size: 1.1em; margin-right: 4px;">üìö</span> <strong>{{ lesson.contract.student.first_name }}</strong>
                                        {% if lesson.id in conflicts_by_lesson %}
                                        <a href="{% url 'lessons:conflicts' lesson.pk %}" style="color: #ffeb3b; font-size: 1.1em; margin-left: 4px; text-decoration: none;" title="{% trans 'Conflict detected - Click for details' %}" onclick="event.stopPropagation();">‚ö†Ô∏è</a>
                                        {% endif %}<br>
                                        <small style="opacity: 0.9;">{{ lesson.start_time|time:'H:i' }} - {{ lesson.duration_minutes }} {% trans "Min." %}</small>
                                        {% if lesson.status == 'paid' %}<small style="display: block; opacity: 0.8;">‚úì {% trans "Paid" %}</small>{% endif %}
                                    </div>
                                    <a href="{% url 'lessons:update' lesson.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}" 
                                       style="color: white; text-decoration: none; font-size: 1.1em; padding: 2px 4px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-left: 4px; flex-shrink: 0;"
                                       title="{% trans 'Edit lesson' %}"
                                       onclick="event.stopPropagation();">
                                        ‚úèÔ∏è
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% for blocked_time in weekday.blocked_times %}
                            {% with start_hour=blocked_time.start_datetime|local_hour start_minute=blocked_time.start_datetime|local_minute end_hour=blocked_time.end_datetime|local_hour end_minute=blocked_time.end_datetime|local_minute %}
                            {% if start_hour|add:0 == hour|add:0 %}
                            {% with duration_minutes=blocked_time.end_datetime|timesince:blocked_time.start_datetime %}
                            <div class="blocked-time-block" 
                                 data-blocked-time-id="{{ blocked_time.id }}"
                                 data-start-hour="{{ start_hour }}"
                                 data-start-minute="{{ start_minute }}"
                                 data-end-hour="{{ end_hour }}"
                                 data-end-minute="{{ end_minute }}"
                                 style="position: absolute; 
                                        top: {{ start_minute }}px; 
                                        height: {% if start_hour == end_hour %}{{ end_minute|add:"-"|add:start_minute }}{% else %}60{% endif %}px; 
                                        left: 0; 
                                        right: 0; 
                                        background: #ff9800; 
                                        color: white; 
                                        padding: 2px 4px; 
                                        font-size: 0.75em; 
                                        border-radius: 3px;
                                        cursor: pointer;
                                        z-index: 10;
                                        overflow: hidden;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                        transition: all 0.2s;"
                                 onmouseover="showBlockedTimePreview(this, event); this.style.background='#e68900'; this.style.transform='scale(1.02)'; this.style.zIndex='20';"
                                 onmouseout="hideBlockedTimePreview(); this.style.background='#ff9800'; this.style.transform='scale(1)'; this.style.zIndex='10';"
                                 onclick="event.stopPropagation(); window.location.href='{% url 'blocked_times:update' blocked_time.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}'"
                                 title="{{ blocked_time.title }} - {{ blocked_time.start_datetime|time:'H:i' }} bis {{ blocked_time.end_datetime|time:'H:i' }}">
                                <span style="font-size: 1.1em;">üö´</span> <strong>{{ blocked_time.title }}</strong><br>
                                <small>{{ blocked_time.start_datetime|time:'H:i' }} - {{ blocked_time.end_datetime|time:'H:i' }}</small>
                            </div>
                            {% endwith %}
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Dialog for appointment creation -->
<div id="create-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 400px;">
    <h3 style="margin-top: 0;">{% trans "Create New Appointment" %}</h3>
    <p id="dialog-time-info" style="margin-bottom: 15px; color: #2c3e50;"></p>
    <div style="margin-bottom: 15px;">
        <label>
            <input type="radio" name="event-type" value="lesson" checked> {% trans "Tutoring Lesson" %}
        </label><br>
        <label>
            <input type="radio" name="event-type" value="blocked_time"> {% trans "Blocked Time/Other Appointment" %}
        </label>
    </div>
    <div class="btn-group">
        <button onclick="confirmCreate()" class="btn btn-success">{% trans "Create" %}</button>
        <button onclick="cancelCreate()" class="btn btn-secondary">{% trans "Cancel" %}</button>
    </div>
</div>

<div id="dialog-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

<style>
.time-slot:hover {
    background: #f0f0f0;
}
.time-slot.dragging {
    background: #e3f2fd;
}
.lesson-block.has-conflict {
    border: 2px solid #dc3545 !important;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}
</style>

<script>
let dragState = {
    isDragging: false,
    startCell: null,
    endCell: null,
    startTime: null,
    endTime: null
};

function startDrag(event, cell) {
    if (event.button !== 0) return; // Nur linke Maustaste
    event.preventDefault();
    dragState.isDragging = true;
    dragState.startCell = cell;
    dragState.startTime = getTimeFromCell(cell);
    cell.classList.add('dragging');
}

function handleDrag(event, cell) {
    if (!dragState.isDragging) return;
    if (cell.dataset.date !== dragState.startCell.dataset.date) return; // Nur gleicher Tag
    
    dragState.endCell = cell;
    dragState.endTime = getTimeFromCell(cell);
    
    // Markiere alle Zellen zwischen start und end
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('dragging');
        if (slot.dataset.date === dragState.startCell.dataset.date) {
            const slotHour = parseInt(slot.dataset.hour);
            const startHour = parseInt(dragState.startCell.dataset.hour);
            const endHour = parseInt(cell.dataset.hour);
            if (slotHour >= Math.min(startHour, endHour) && slotHour <= Math.max(startHour, endHour)) {
                slot.classList.add('dragging');
            }
        }
    });
}

function endDrag(event, cell) {
    if (!dragState.isDragging) return;
    
    dragState.isDragging = false;
    dragState.endCell = cell;
    dragState.endTime = getTimeFromCell(cell);
    
    // Berechne Start- und Endzeit
    const startHour = parseInt(dragState.startCell.dataset.hour);
    const endHour = parseInt(dragState.endCell.dataset.hour);
    const date = dragState.startCell.dataset.date;
    
    // Normalisiere (start sollte vor end sein)
    const actualStartHour = Math.min(startHour, endHour);
    const actualEndHour = Math.max(startHour, endHour) + 1; // +1 f√ºr volle Stunde
    
    const startDateTime = new Date(date + 'T' + String(actualStartHour).padStart(2, '0') + ':00:00');
    const endDateTime = new Date(date + 'T' + String(actualEndHour).padStart(2, '0') + ':00:00');
    
    // Zeige Dialog
    showCreateDialog(startDateTime, endDateTime, date);
    
    // Entferne Markierungen
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('dragging');
    });
}

function cancelDrag(event) {
    if (dragState.isDragging) {
        dragState.isDragging = false;
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('dragging');
        });
    }
}

function getTimeFromCell(cell) {
    return {
        hour: parseInt(cell.dataset.hour),
        date: cell.dataset.date
    };
}

function showCreateDialog(startDateTime, endDateTime, date) {
    const dialog = document.getElementById('create-dialog');
    const overlay = document.getElementById('dialog-overlay');
    const timeInfo = document.getElementById('dialog-time-info');
    
    const startStr = startDateTime.toISOString().slice(0, 16);
    const endStr = endDateTime.toISOString().slice(0, 16);
    
    // Get current language from HTML lang attribute or default to 'en'
    const currentLang = document.documentElement.lang || 'en';
    const locale = currentLang === 'de' ? 'de-DE' : 'en-US';
    const fromText = currentLang === 'de' ? 'Von:' : 'From:';
    const toText = currentLang === 'de' ? 'bis' : 'to';
    const onText = currentLang === 'de' ? 'am' : 'on';
    
    timeInfo.textContent = `${fromText} ${startDateTime.toLocaleTimeString(locale, {hour: '2-digit', minute: '2-digit'})} ${toText} ${endDateTime.toLocaleTimeString(locale, {hour: '2-digit', minute: '2-digit'})} ${onText} ${new Date(date).toLocaleDateString(locale)}`;
    
    dialog.dataset.start = startStr;
    dialog.dataset.end = endStr;
    dialog.dataset.date = date;
    
    dialog.style.display = 'block';
    overlay.style.display = 'block';
}

function confirmCreate() {
    const dialog = document.getElementById('create-dialog');
    const eventType = document.querySelector('input[name="event-type"]:checked').value;
    const start = dialog.dataset.start;
    const end = dialog.dataset.end;
    
    let url;
    if (eventType === 'lesson') {
        url = '{% url "lessons:create" %}?start=' + encodeURIComponent(start) + '&end=' + encodeURIComponent(end);
    } else {
        url = '{% url "blocked_times:create" %}?start=' + encodeURIComponent(start) + '&end=' + encodeURIComponent(end);
    }
    
    window.location.href = url;
}

function cancelCreate() {
    document.getElementById('create-dialog').style.display = 'none';
    document.getElementById('dialog-overlay').style.display = 'none';
}

// Schlie√üe Dialog bei Klick auf Overlay
document.getElementById('dialog-overlay').addEventListener('click', cancelCreate);

// Hover-Preview f√ºr Lessons
let previewTooltip = null;

function showLessonPreview(element, event) {
    if (previewTooltip) return;
    
    const lessonId = element.dataset.lessonId;
    const studentName = element.querySelector('strong').textContent.trim();
    const timeInfo = element.querySelector('small').textContent.trim();
    const hasConflict = element.classList.contains('has-conflict');
    
    previewTooltip = document.createElement('div');
    previewTooltip.style.cssText = `
        position: absolute;
        background: #2c3e50;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        max-width: 250px;
        white-space: nowrap;
    `;
    previewTooltip.innerHTML = `
        <strong>${studentName}</strong><br>
        <small>${timeInfo}</small>
        ${hasConflict ? '<br><small style="color: #ffeb3b;">‚ö†Ô∏è {% trans "Conflict" %}</small>' : ''}
    `;
    
    document.body.appendChild(previewTooltip);
    const rect = element.getBoundingClientRect();
    previewTooltip.style.left = (rect.left + rect.width / 2 - previewTooltip.offsetWidth / 2) + 'px';
    previewTooltip.style.top = (rect.top - previewTooltip.offsetHeight - 8) + 'px';
}

function hideLessonPreview() {
    if (previewTooltip) {
        previewTooltip.remove();
        previewTooltip = null;
    }
}

function showBlockedTimePreview(element, event) {
    if (previewTooltip) return;
    
    const title = element.querySelector('strong').textContent.trim();
    const timeInfo = element.querySelector('small').textContent.trim();
    
    previewTooltip = document.createElement('div');
    previewTooltip.style.cssText = `
        position: absolute;
        background: #2c3e50;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        max-width: 250px;
        white-space: nowrap;
    `;
    previewTooltip.innerHTML = `
        <strong>${title}</strong><br>
        <small>${timeInfo}</small>
    `;
    
    document.body.appendChild(previewTooltip);
    const rect = element.getBoundingClientRect();
    previewTooltip.style.left = (rect.left + rect.width / 2 - previewTooltip.offsetWidth / 2) + 'px';
    previewTooltip.style.top = (rect.top - previewTooltip.offsetHeight - 8) + 'px';
}

function hideBlockedTimePreview() {
    if (previewTooltip) {
        previewTooltip.remove();
        previewTooltip = null;
    }
}
</script>
{% endblock %}
