{% extends 'core/base.html' %}
{% load i18n %}
{% load static %}
{% load lesson_filters %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">
{% endblock %}

{% block title %}{% trans "Week View" %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Week View" %}</h1>

<div class="btn-group">
    <a href="{% url 'lessons:week' %}?year={{ prev_week.year }}&month={{ prev_week.month }}&day={{ prev_week.day }}" class="btn">‚Üê {% trans "Previous Week" %}</a>
    <a href="{% url 'lessons:week' %}?year={{ next_week.year }}&month={{ next_week.month }}&day={{ next_week.day }}" class="btn">{% trans "Next Week" %} ‚Üí</a>
</div>

<p class="calendar-note">
    <strong>{% trans "Note:" %}</strong> {% trans "Lessons and blocked times can be created by clicking in a time block; drag-to-create is not implemented." %}
</p>

<div id="week-calendar" class="week-calendar">
    <table class="week-table">
        <thead>
            <tr>
                <th class="time-slot-label">{% trans "Time" %}</th>
                {% for weekday in weekdays %}
                <th class="week-day-header {% if weekday.date == today %}is-today{% endif %}">
                    {{ weekday.name_short }}<br>
                    <small class="weekday-date">{{ weekday.date.day }}.{{ weekday.date.month }}.</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
            <tr data-hour="{{ hour }}" class="time-row">
                <td class="time-slot-label">
                    {{ hour }}:00
                </td>
                {% for weekday in weekdays %}
                <td class="time-slot"
                    data-date="{{ weekday.date|date:'Y-m-d' }}"
                    data-hour="{{ hour }}">
                    <div class="slot-content">
                        {% for lesson in weekday.lessons %}
                            {% if lesson.start_time.hour|add:0 == hour|add:0 %}
                            <div class="lesson-block status-{{ lesson.status }} {% if lesson.id in conflicts_by_lesson %}has-conflict{% endif %}"
                                 data-lesson-id="{{ lesson.id }}"
                                 data-start-minute="{{ lesson.start_time.minute }}"
                                 data-duration="{{ lesson.duration_minutes }}"
                                 data-plan-url="{% url 'lesson_plans:lesson_plan' lesson.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}"
                                 data-student="{{ lesson.contract.student.first_name }}"
                                 data-time="{{ lesson.start_time|time:'H:i' }} - {{ lesson.duration_minutes }} {% trans 'Min.' %}"
                                 data-has-conflict="{% if lesson.id in conflicts_by_lesson %}true{% else %}false{% endif %}">
                                <div class="lesson-header">
                                    <div class="lesson-title">
                                        <span>üìö</span> <strong>{{ lesson.contract.student.first_name }}</strong>
                                        {% if lesson.id in conflicts_by_lesson %}
                                        <a href="{% url 'lessons:conflicts' lesson.pk %}" class="lesson-conflict-link js-stop-propagation" title="{% trans 'Conflict detected - Click for details' %}" aria-label="{% trans 'View Conflicts' %}">‚ö†Ô∏è</a>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'lessons:update' lesson.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}"
                                       class="lesson-edit js-stop-propagation"
                                       title="{% trans 'Edit lesson' %}" aria-label="{% trans 'Edit Lesson' %}">
                                        ‚úèÔ∏è
                                    </a>
                                </div>
                                <small class="lesson-meta">{{ lesson.start_time|time:'H:i' }} - {{ lesson.duration_minutes }} {% trans "Min." %}</small>
                                {% if lesson.status == 'paid' %}<small class="lesson-paid">‚úì {% trans "Paid" %}</small>{% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% for blocked_time in weekday.blocked_times %}
                            {% with start_hour=blocked_time.start_datetime|local_hour start_minute=blocked_time.start_datetime|local_minute end_hour=blocked_time.end_datetime|local_hour end_minute=blocked_time.end_datetime|local_minute %}
                            {% if start_hour|add:0 == hour|add:0 %}
                            <div class="blocked-time-block lesson-block"
                                 data-blocked-time-id="{{ blocked_time.id }}"
                                 data-start-minute="{{ start_minute }}"
                                 data-end-minute="{{ end_minute }}"
                                 data-edit-url="{% url 'blocked_times:update' blocked_time.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}"
                                 data-title="{{ blocked_time.title }}"
                                 data-time="{{ blocked_time.start_datetime|time:'H:i' }} - {{ blocked_time.end_datetime|time:'H:i' }}">
                                <span>üö´</span> <strong>{{ blocked_time.title }}</strong><br>
                                <small>{{ blocked_time.start_datetime|time:'H:i' }} - {{ blocked_time.end_datetime|time:'H:i' }}</small>
                            </div>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Dialog for appointment creation -->
<div id="create-dialog" class="create-dialog"
     data-lesson-create-url="{% url 'lessons:create' %}"
     data-blocked-create-url="{% url 'blocked_times:create' %}">
    <h3>{% trans "Create New Appointment" %}</h3>
    <p id="dialog-time-info"></p>
    <div class="dialog-body">
        <label>
            <input type="radio" name="event-type" value="lesson" checked> {% trans "Tutoring Lesson" %}
        </label><br>
        <label>
            <input type="radio" name="event-type" value="blocked_time"> {% trans "Blocked Time/Other Appointment" %}
        </label>
    </div>
    <div class="btn-group">
        <button class="btn btn-success js-confirm-create" aria-label="{% trans 'Create Lesson' %}">{% trans "Create" %}</button>
        <button type="button" class="btn btn-secondary js-cancel-create" aria-label="{% trans 'Cancel' %}">{% trans "Cancel" %}</button>
    </div>
</div>

<div id="dialog-overlay" class="dialog-overlay"></div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/calendar.js' %}"></script>
{% endblock %}
