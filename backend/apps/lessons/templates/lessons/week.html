{% extends 'core/base.html' %}
{% load i18n %}
{% load lesson_filters %}

{% block title %}{% trans "Week View" %} - TutorFlow{% endblock %}

{% block content %}
<h1>{% trans "Week View" %}</h1>

<div class="btn-group">
    <a href="{% url 'lessons:week' %}?year={{ prev_week.year }}&month={{ prev_week.month }}&day={{ prev_week.day }}" class="btn">‚Üê {% trans "Previous Week" %}</a>
    <a href="{% url 'lessons:calendar' %}?year={{ week_start.year }}&month={{ week_start.month }}" class="btn">üìÖ {% trans "Month View" %}</a>
    <a href="{% url 'lessons:week' %}?year={{ next_week.year }}&month={{ next_week.month }}&day={{ next_week.day }}" class="btn">{% trans "Next Week" %} ‚Üí</a>
</div>

<div style="margin-top: 10px; margin-bottom: 10px;">
    <label style="display: inline-flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="select-all-blocked-times" style="margin-right: 5px;">
        <span>{% trans "Select all blocked times" %}</span>
    </label>
    <button type="button" id="delete-selected-blocked-times" class="btn btn-danger" style="margin-left: 15px; display: none;" onclick="deleteSelectedBlockedTimes()">
        üóëÔ∏è {% trans "Delete Selected" %}
    </button>
</div>

<div style="margin-bottom: 20px; margin-top: 10px;">
    <form method="get" action="{% url 'lessons:week' %}" style="display: inline-block;">
        <label for="date-select">{% trans "Jump to date:" %}</label>
        <input type="date" id="date-select" name="date" value="{{ week_start|date:'Y-m-d' }}" 
               onchange="this.form.submit()" style="margin-left: 10px; padding: 5px;">
    </form>
    <script>
        document.getElementById('date-select').addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth() + 1;
            const day = selectedDate.getDate();
            window.location.href = '{% url "lessons:week" %}?year=' + year + '&month=' + month + '&day=' + day;
        });
    </script>
</div>

<p class="calendar-note" style="margin-top: 10px; color: #495057; font-size: 0.9em;">
    <strong>{% trans "Note:" %}</strong> {% trans "Lessons and blocked times can be created by clicking in a time block; drag-to-create is not implemented." %}
</p>

<div id="week-calendar" class="week-calendar" style="margin-top: 20px; position: relative; overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr>
                <th class="time-label" style="width: 80px; border: 1px solid var(--border-color); padding: 8px; background: var(--table-header-bg); text-align: center; color: var(--text-primary);">{% trans "Time" %}</th>
                {% for weekday in weekdays %}
                <th class="{% if weekday.date == today %}today-header{% endif %}" style="border: 1px solid var(--border-color); padding: 8px; background: var(--table-header-bg); text-align: center; {% if weekday.date == today %}background: rgba(33, 150, 243, 0.15);{% endif %} color: var(--text-primary);">
                    {{ weekday.name_short }}<br>
                    <small style="font-weight: normal;">{{ weekday.date.day }}.{{ weekday.date.month }}.</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
            <tr data-hour="{{ hour }}" style="height: 60px; position: relative;">
                <td class="time-label" style="border: 1px solid var(--border-color); padding: 4px; text-align: center; background: rgba(255,255,255,0.03); font-size: 0.85em; color: var(--text-primary);">
                    {{ hour }}:00
                </td>
                {% for weekday in weekdays %}
                <td class="time-slot" 
                    data-date="{{ weekday.date|date:'Y-m-d' }}" 
                    data-hour="{{ hour }}"
                    style="border: 1px solid var(--border-color); padding: 0; position: relative; vertical-align: top; cursor: pointer; overflow: visible; background: var(--bg-secondary);"
                    onclick="openCreateFromSlot(this)">
                    <div class="slot-content" style="position: relative; height: 100%; width: 100%; overflow: visible; min-height: 60px;">
                        {% for lesson in weekday.lessons %}
                            {% comment %}Render block in the hour row where lesson starts{% endcomment %}
                            {% if lesson.start_time.hour|add:0 == hour|add:0 %}
                            <div class="lesson-block {% if lesson.id in conflicts_by_lesson %}has-conflict{% endif %}" 
                                 data-lesson-id="{{ lesson.id }}"
                                 data-start-hour="{{ lesson.start_time.hour }}"
                                 data-start-minute="{{ lesson.start_time.minute }}"
                                 data-duration="{{ lesson.duration_minutes }}"
                                 data-travel-before="{{ lesson.travel_time_before_minutes }}"
                                 data-travel-after="{{ lesson.travel_time_after_minutes }}"
                                 data-total-time="{{ lesson.total_time_minutes }}"
                                 data-render-hour="{{ hour }}"
                                 data-lesson-date="{{ weekday.date|date:'Y-m-d' }}"
                                 style="position: absolute; 
                                        left: 0; 
                                        right: 0; 
                                        background: {% if lesson.status == 'paid' %}#2e7d32{% elif lesson.status == 'taught' %}#607d8b{% else %}#2196f3{% endif %}; 
                                        color: white; 
                                        padding: 2px 4px; 
                                        font-size: 0.75em; 
                                        border-radius: 3px;
                                        cursor: pointer;
                                        z-index: 10;
                                        overflow: hidden;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                        transition: all 0.2s;
                                        {% if lesson.id in conflicts_by_lesson %}border: 2px solid #dc3545;{% endif %}"
                                 onmouseover="showLessonPreview(this, event); this.style.transform='scale(1.02)'; this.style.zIndex='20';"
                                 onmouseout="hideLessonPreview(); this.style.transform='scale(1)'; this.style.zIndex='10';"
                                 onclick="event.stopPropagation(); window.location.href='/lesson-plans/lessons/{{ lesson.pk }}/?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}'"
                                 title="{% if lesson.travel_time_before_minutes > 0 %}üöó {{ lesson.travel_time_before_minutes }} {% trans 'Min.' %} ‚Üí {% endif %}{{ lesson.contract.student.full_name }} - {{ lesson.start_time|time:'H:i' }} ({{ lesson.duration_minutes }} {% trans 'Min.' %}){% if lesson.travel_time_after_minutes > 0 %} ‚Üí üöó {{ lesson.travel_time_after_minutes }} {% trans 'Min.' %}{% endif %} - {% trans 'Click to view lesson plan' %}">
                                {% if lesson.travel_time_before_minutes > 0 %}
                                <div style="background: rgba(255,255,255,0.15); padding: 1px 4px; margin: -2px -4px 2px -4px; font-size: 0.7em; border-radius: 3px 3px 0 0;">
                                    üöó {{ lesson.travel_time_before_minutes }} {% trans "Min." %}
                                </div>
                                {% endif %}
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <span style="font-size: 1.1em; margin-right: 4px;">üìö</span> <strong>{{ lesson.contract.student.first_name }}</strong>
                                        {% if lesson.id in conflicts_by_lesson %}
                                        <a href="{% url 'lessons:conflicts' lesson.pk %}" style="color: #ffeb3b; font-size: 1.1em; margin-left: 4px; text-decoration: none;" title="{% trans 'Conflict detected - Click for details' %}" aria-label="{% trans 'View Conflicts' %}" onclick="event.stopPropagation();">‚ö†Ô∏è</a>
                                        {% endif %}<br>
                                        <small style="opacity: 0.9;">{{ lesson.start_time|time:'H:i' }} - {{ lesson.duration_minutes }} {% trans "Min." %}</small>
                                        {% if lesson.status == 'paid' %}<small style="display: block; opacity: 0.8;">‚úì {% trans "Paid" %}</small>{% endif %}
                                    </div>
                                    <a href="{% url 'lessons:update' lesson.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}" 
                                       style="color: white; text-decoration: none; font-size: 1.1em; padding: 2px 4px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-left: 4px; flex-shrink: 0;"
                                       title="{% trans 'Edit lesson' %}" aria-label="{% trans 'Edit Lesson' %}"
                                       onclick="event.stopPropagation();">
                                        ‚úèÔ∏è
                                    </a>
                                </div>
                                {% if lesson.travel_time_after_minutes > 0 %}
                                <div style="background: rgba(255,255,255,0.15); padding: 1px 4px; margin: 2px -4px -2px -4px; font-size: 0.7em; border-radius: 0 0 3px 3px;">
                                    üöó {{ lesson.travel_time_after_minutes }} {% trans "Min." %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% for blocked_time in weekday.blocked_times %}
                            {% with start_hour=blocked_time.start_datetime|local_hour start_minute=blocked_time.start_datetime|local_minute end_hour=blocked_time.end_datetime|local_hour end_minute=blocked_time.end_datetime|local_minute %}
                            {% comment %}Zeige Blockzeit in allen betroffenen Stunden{% endcomment %}
                            {% if hour|add:0 >= start_hour|add:0 and hour|add:0 <= end_hour|add:0 %}
                            <div class="blocked-time-block lesson-block" 
                                 data-blocked-time-id="{% if blocked_time.pk %}{{ blocked_time.pk }}{% else %}preview-{{ forloop.counter }}{% endif %}"
                                 data-start-hour="{{ start_hour }}"
                                 data-start-minute="{{ start_minute }}"
                                 data-end-hour="{{ end_hour }}"
                                 data-end-minute="{{ end_minute }}"
                                 data-render-hour="{{ hour }}"
                                 {% if blocked_time.pk %}data-has-pk="true"{% endif %}
                                 style="position: absolute; 
                                        top: {% if hour == start_hour %}{{ start_minute }}{% else %}0{% endif %}px; 
                                        height: {% if hour == start_hour and hour == end_hour %}{{ end_minute|add:"-"|add:start_minute }}{% elif hour == start_hour %}{{ 60|add:"-"|add:start_minute }}{% elif hour == end_hour %}{{ end_minute }}{% else %}60{% endif %}px; 
                                        left: 0; 
                                        right: 0; 
                                        background: #ff9800; 
                                        color: white; 
                                        padding: 2px 4px; 
                                        font-size: 0.75em; 
                                        border-radius: 3px;
                                        cursor: {% if blocked_time.pk %}pointer{% else %}default{% endif %};
                                        z-index: 10;
                                        overflow: hidden;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                        transition: all 0.2s;"
                                 onmouseover="showBlockedTimePreview(this, event); this.style.background='#e68900'; this.style.transform='scale(1.02)'; this.style.zIndex='20';"
                                 onmouseout="hideBlockedTimePreview(); this.style.background='#ff9800'; this.style.transform='scale(1)'; this.style.zIndex='10';"
                                 {% if blocked_time.pk %}onclick="event.stopPropagation(); window.location.href='{% url 'blocked_times:update' blocked_time.pk %}?year={{ weekday.date.year }}&month={{ weekday.date.month }}&day={{ weekday.date.day }}'"{% endif %}
                                 title="{{ blocked_time.title }} - {{ blocked_time.start_datetime|time:'H:i' }} to {{ blocked_time.end_datetime|time:'H:i' }}{% if not blocked_time.pk %} ({% trans 'Preview - not yet created' %}){% endif %}">
                                <div style="display: flex; align-items: flex-start; gap: 4px;">
                                    {% if blocked_time.pk %}
                                    <input type="checkbox" class="blocked-time-checkbox" data-blocked-time-id="{{ blocked_time.pk }}" style="margin-top: 2px; flex-shrink: 0; cursor: pointer;" onchange="updateDeleteButton()" onclick="event.stopPropagation();">
                                    {% endif %}
                                    <div style="flex: 1;">
                                        {% if hour == start_hour %}
                                        <span style="font-size: 1.1em;">üö´</span> <strong>{{ blocked_time.title }}</strong><br>
                                        <small>{{ blocked_time.start_datetime|time:'H:i' }} - {{ blocked_time.end_datetime|time:'H:i' }}</small>
                                        {% else %}
                                        <span style="font-size: 1.1em;">üö´</span> <strong>{{ blocked_time.title }}</strong>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Dialog for appointment creation -->
<div id="create-dialog" class="create-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px var(--shadow); z-index: 1000; min-width: 400px; color: var(--text-primary); border: 1px solid var(--border-color);">
    <h3 style="margin-top: 0; color: var(--text-primary);">{% trans "Create New Appointment" %}</h3>
    <p id="dialog-time-info" style="margin-bottom: 15px; color: var(--text-secondary);"></p>
    <div style="margin-bottom: 15px;">
        <label>
            <input type="radio" name="event-type" value="lesson" checked> {% trans "Tutoring Lesson" %}
        </label><br>
        <label>
            <input type="radio" name="event-type" value="blocked_time"> {% trans "Blocked Time/Other Appointment" %}
        </label>
    </div>
    <div class="btn-group">
        <button onclick="confirmCreate()" class="btn btn-success" aria-label="{% trans 'Create Lesson' %}">{% trans "Create" %}</button>
        <button onclick="cancelCreate()" class="btn btn-secondary" aria-label="{% trans 'Cancel' %}">{% trans "Cancel" %}</button>
    </div>
</div>

<div id="dialog-overlay" class="create-dialog-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

<style>
.time-slot:hover {
    background: rgba(255,255,255,0.05);
}
[data-theme="dark"] .time-slot:hover {
    background: rgba(255,255,255,0.08);
}
.time-slot.dragging {
    background: rgba(33, 150, 243, 0.2);
}
.lesson-block.has-conflict {
    border: 2px solid #dc3545 !important;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}
[data-theme="dark"] .create-dialog-overlay {
    background: rgba(0,0,0,0.7);
}
</style>

<script>
function openCreateFromSlot(cell) {
    const date = cell.dataset.date;
    const hour = parseInt(cell.dataset.hour);
    const startDateTime = new Date(date + 'T' + String(hour).padStart(2, '0') + ':00:00');
    const endDateTime = new Date(date + 'T' + String(hour + 1).padStart(2, '0') + ':00:00');
    showCreateDialog(startDateTime, endDateTime, date);
}

function showCreateDialog(startDateTime, endDateTime, date) {
    const dialog = document.getElementById('create-dialog');
    const overlay = document.getElementById('dialog-overlay');
    const timeInfo = document.getElementById('dialog-time-info');
    
    // Format datetime as YYYY-MM-DDTHH:MM in local time (not UTC)
    // This avoids timezone conversion issues
    function formatLocalDateTime(dt) {
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    const startStr = formatLocalDateTime(startDateTime);
    const endStr = formatLocalDateTime(endDateTime);
    
    const locale = 'en-US';
    timeInfo.textContent = `From: ${startDateTime.toLocaleTimeString(locale, {hour: '2-digit', minute: '2-digit'})} to ${endDateTime.toLocaleTimeString(locale, {hour: '2-digit', minute: '2-digit'})} on ${new Date(date).toLocaleDateString(locale)}`;
    
    dialog.dataset.start = startStr;
    dialog.dataset.end = endStr;
    dialog.dataset.date = date;
    
    dialog.style.display = 'block';
    overlay.style.display = 'block';
}

function confirmCreate() {
    const dialog = document.getElementById('create-dialog');
    const eventType = document.querySelector('input[name="event-type"]:checked').value;
    const start = dialog.dataset.start;
    const end = dialog.dataset.end;
    
    let url;
    if (eventType === 'lesson') {
        url = '{% url "lessons:create" %}?start=' + encodeURIComponent(start) + '&end=' + encodeURIComponent(end);
    } else {
        url = '{% url "blocked_times:create" %}?start=' + encodeURIComponent(start) + '&end=' + encodeURIComponent(end);
    }
    
    window.location.href = url;
}

function cancelCreate() {
    document.getElementById('create-dialog').style.display = 'none';
    document.getElementById('dialog-overlay').style.display = 'none';
}

// Close dialog when clicking on the overlay
document.getElementById('dialog-overlay').addEventListener('click', cancelCreate);

// Hover preview for lessons
let previewTooltip = null;

function showLessonPreview(element, event) {
    if (previewTooltip) return;
    
    const lessonId = element.dataset.lessonId;
    const studentName = element.querySelector('strong').textContent.trim();
    const timeInfo = element.querySelector('small').textContent.trim();
    const hasConflict = element.classList.contains('has-conflict');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    previewTooltip = document.createElement('div');
    previewTooltip.className = 'preview-tooltip';
    previewTooltip.style.cssText = `
        position: absolute;
        background: ${isDark ? '#1e1e1e' : '#2c3e50'};
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px ${isDark ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.3)'};
        max-width: 250px;
        white-space: nowrap;
    `;
    previewTooltip.innerHTML = `
        <strong>${studentName}</strong><br>
        <small>${timeInfo}</small>
        ${hasConflict ? '<br><small style="color: #ffeb3b;">‚ö†Ô∏è {% trans "Conflict" %}</small>' : ''}
    `;
    
    document.body.appendChild(previewTooltip);
    const rect = element.getBoundingClientRect();
    previewTooltip.style.left = (rect.left + rect.width / 2 - previewTooltip.offsetWidth / 2) + 'px';
    previewTooltip.style.top = (rect.top - previewTooltip.offsetHeight - 8) + 'px';
}

function hideLessonPreview() {
    if (previewTooltip) {
        previewTooltip.remove();
        previewTooltip = null;
    }
}

function showBlockedTimePreview(element, event) {
    if (previewTooltip) return;
    
    const title = element.querySelector('strong').textContent.trim();
    const timeInfo = element.querySelector('small').textContent.trim();
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    previewTooltip = document.createElement('div');
    previewTooltip.className = 'preview-tooltip';
    previewTooltip.style.cssText = `
        position: absolute;
        background: ${isDark ? '#1e1e1e' : '#2c3e50'};
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px ${isDark ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.3)'};
        max-width: 250px;
        white-space: nowrap;
    `;
    previewTooltip.innerHTML = `
        <strong>${title}</strong><br>
        <small>${timeInfo}</small>
    `;
    
    document.body.appendChild(previewTooltip);
    const rect = element.getBoundingClientRect();
    previewTooltip.style.left = (rect.left + rect.width / 2 - previewTooltip.offsetWidth / 2) + 'px';
    previewTooltip.style.top = (rect.top - previewTooltip.offsetHeight - 8) + 'px';
}

function hideBlockedTimePreview() {
    if (previewTooltip) {
        previewTooltip.remove();
        previewTooltip = null;
    }
}

// Calculate position and height of lesson blocks considering travel time
document.addEventListener('DOMContentLoaded', function() {
    const lessonBlocks = document.querySelectorAll('.lesson-block[data-total-time]');
    const blocksToMove = []; // Collect blocks that need to be moved
    
    // First pass: identify blocks that need to be moved
    lessonBlocks.forEach(function(block) {
        const startHour = parseInt(block.dataset.startHour) || 0;
        const startMinute = parseInt(block.dataset.startMinute) || 0;
        const travelBefore = parseInt(block.dataset.travelBefore) || 0;
        const renderHour = parseInt(block.dataset.renderHour) || startHour;
        
        // Calculate actual start time in minutes (start time minus travel time before)
        const actualStartMinutes = (startHour * 60 + startMinute) - travelBefore;
        const actualStartHour = Math.floor(actualStartMinutes / 60);
        const actualStartMinute = actualStartMinutes % 60;
        
        if (actualStartHour !== renderHour) {
            blocksToMove.push({
                block: block,
                actualStartHour: actualStartHour,
                actualStartMinute: actualStartMinute,
                renderHour: renderHour
            });
        }
    });
    
    // Second pass: move blocks to correct rows
    blocksToMove.forEach(function(item) {
        const block = item.block;
        const actualStartHour = item.actualStartHour;
        const actualStartMinute = item.actualStartMinute;
        const renderHour = item.renderHour;
        const lessonId = block.dataset.lessonId;
        const lessonDate = block.dataset.lessonDate;
        const totalTime = parseInt(block.dataset.totalTime) || parseInt(block.dataset.duration) || 0;
        
        // Find the correct row
        const currentRow = block.closest('tr');
        let targetRow = null;
        
        if (actualStartHour < renderHour) {
            // Block should be in previous row - search backwards
            let row = currentRow.previousElementSibling;
            while (row) {
                const rowHour = parseInt(row.dataset.hour);
                if (rowHour === actualStartHour) {
                    targetRow = row;
                    break;
                }
                if (rowHour < actualStartHour) {
                    break; // Too far back
                }
                row = row.previousElementSibling;
            }
        } else {
            // Block should be in next row (rare)
            let row = currentRow.nextElementSibling;
            while (row) {
                const rowHour = parseInt(row.dataset.hour);
                if (rowHour === actualStartHour) {
                    targetRow = row;
                    break;
                }
                if (rowHour > actualStartHour) {
                    break; // Too far ahead
                }
                row = row.nextElementSibling;
            }
        }
        
        if (targetRow) {
            // Find the corresponding time slot in the target row
            const timeSlot = targetRow.querySelector(`td.time-slot[data-date="${lessonDate}"]`);
            if (timeSlot) {
                const slotContent = timeSlot.querySelector('.slot-content');
                if (slotContent && !slotContent.querySelector(`.lesson-block[data-lesson-id="${lessonId}"]`)) {
                    // Move block to the correct row
                    block.remove();
                    block.dataset.renderHour = actualStartHour.toString();
                    block.style.top = actualStartMinute + 'px';
                    block.style.height = totalTime + 'px';
                    slotContent.appendChild(block);
                    return; // Block was moved
                }
            }
        }
    });
    
    // Third pass: position all blocks (including moved ones)
    document.querySelectorAll('.lesson-block[data-total-time]').forEach(function(block) {
        const startHour = parseInt(block.dataset.startHour) || 0;
        const startMinute = parseInt(block.dataset.startMinute) || 0;
        const travelBefore = parseInt(block.dataset.travelBefore) || 0;
        const totalTime = parseInt(block.dataset.totalTime) || parseInt(block.dataset.duration) || 0;
        const renderHour = parseInt(block.dataset.renderHour) || startHour;
        
        // Calculate actual start time in minutes (start time minus travel time before)
        const actualStartMinutes = (startHour * 60 + startMinute) - travelBefore;
        const actualStartHour = Math.floor(actualStartMinutes / 60);
        const actualStartMinute = actualStartMinutes % 60;
        
        // Position: relative to the row where the block currently is
        if (actualStartHour === renderHour) {
            block.style.top = actualStartMinute + 'px';
            block.style.height = totalTime + 'px';
        } else {
            // Block is still in wrong row - position relative to current row
            if (actualStartHour < renderHour) {
                // Block should be in previous hour, position negatively
                block.style.top = (actualStartMinute - 60) + 'px';
            } else {
                block.style.top = actualStartMinute + 'px';
            }
            block.style.height = totalTime + 'px';
        }
    });
});

// Blocked Time Selection and Bulk Delete
function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.blocked-time-checkbox:checked');
    const deleteButton = document.getElementById('delete-selected-blocked-times');
    if (checkboxes.length > 0) {
        deleteButton.style.display = 'inline-block';
        deleteButton.textContent = `üóëÔ∏è {% trans "Delete Selected" %} (${checkboxes.length})`;
    } else {
        deleteButton.style.display = 'none';
    }
}

function deleteSelectedBlockedTimes() {
    const checkboxes = document.querySelectorAll('.blocked-time-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.blockedTimeId);
    
    if (selectedIds.length === 0) {
        alert('{% trans "Please select at least one blocked time to delete." %}');
        return;
    }
    
    if (!confirm(`{% trans "Are you sure you want to delete" %} ${selectedIds.length} {% trans "selected blocked time(s)?" %}`)) {
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "blocked_times:bulk_delete" %}';
    
    // Add CSRF token from cookie
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);
    } else {
        console.error('CSRF token not found');
        alert('{% trans "Error: CSRF token not found. Please refresh the page and try again." %}');
        return;
    }
    
    // Add selected IDs
    selectedIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'blocked_time_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    // Add redirect parameters
    const year = new URLSearchParams(window.location.search).get('year') || '{{ week_start.year }}';
    const month = new URLSearchParams(window.location.search).get('month') || '{{ week_start.month }}';
    const day = new URLSearchParams(window.location.search).get('day') || '{{ week_start.day }}';
    
    const yearInput = document.createElement('input');
    yearInput.type = 'hidden';
    yearInput.name = 'year';
    yearInput.value = year;
    form.appendChild(yearInput);
    
    const monthInput = document.createElement('input');
    monthInput.type = 'hidden';
    monthInput.name = 'month';
    monthInput.value = month;
    form.appendChild(monthInput);
    
    const dayInput = document.createElement('input');
    dayInput.type = 'hidden';
    dayInput.name = 'day';
    dayInput.value = day;
    form.appendChild(dayInput);
    
    document.body.appendChild(form);
    form.submit();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Select all checkbox
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-blocked-times');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.blocked-time-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateDeleteButton();
        });
    }
});
</script>
{% endblock %}
